apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: remediate-externalsecret-failure
  namespace: cicd
  labels:
    app.kubernetes.io/part-of: idp
    app.kubernetes.io/component: remediation
    app.kubernetes.io/name: remediate-externalsecret
  annotations:
    argocd.argoproj.io/sync-wave: "2"
spec:
  entrypoint: recreate-externalsecret
  serviceAccountName: argo-workflow
  arguments:
    parameters:
      - name: externalsecret-name
        value: "unknown"
      - name: namespace
        value: "default"
  
  templates:
    - name: recreate-externalsecret
      inputs:
        parameters:
          - name: externalsecret-name
          - name: namespace
      steps:
        - - name: delete
            template: kubectl-delete
        - - name: wait
            template: wait-for-deletion
        - - name: verify
            template: verify-sync
    
    - name: kubectl-delete
      container:
        image: bitnami/kubectl:1.31
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "=== ExternalSecret Remediation ==="
            echo "ExternalSecret: {{workflow.parameters.externalsecret-name}}"
            echo "Namespace: {{workflow.parameters.namespace}}"
            echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""
            
            echo "Deleting ExternalSecret to force re-sync..."
            kubectl delete externalsecret {{workflow.parameters.externalsecret-name}} \
              -n {{workflow.parameters.namespace}} \
              --wait=false || {
                echo "WARNING: ExternalSecret may not exist or already deleted"
              }
            
            echo "✓ Deletion initiated"
    
    - name: wait-for-deletion
      suspend:
        duration: "10s"
    
    - name: verify-sync
      container:
        image: bitnami/kubectl:1.31
        command: ["/bin/sh", "-c"]
        args:
          - |
            echo "Waiting for ExternalSecret to be recreated and synced..."
            
            # ArgoCD should recreate it, wait for it to be ready
            timeout=60
            elapsed=0
            
            while [ $elapsed -lt $timeout ]; do
              if kubectl get externalsecret {{workflow.parameters.externalsecret-name}} \
                -n {{workflow.parameters.namespace}} &>/dev/null; then
                
                # Check if it's ready
                if kubectl wait --for=condition=Ready \
                  externalsecret/{{workflow.parameters.externalsecret-name}} \
                  -n {{workflow.parameters.namespace}} \
                  --timeout=10s &>/dev/null; then
                  echo "✓ ExternalSecret successfully recreated and synced"
                  exit 0
                fi
              fi
              
              sleep 5
              elapsed=$((elapsed + 5))
              echo "Waiting... ($elapsed/$timeout seconds)"
            done
            
            echo "WARNING: ExternalSecret not ready within timeout"
            echo "Check ArgoCD for sync status"
            exit 1
