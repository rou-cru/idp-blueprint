# @section -- Global labels
commonLabels:
  app.kubernetes.io/version: "2.6.3"
  app.kubernetes.io/part-of: idp
  owner: platform-team
  business-unit: infrastructure
  environment: demo

# @section -- Backstage configuration
backstage:
  # Extra app-config from ConfigMap with DNS_SUFFIX-substituted values
  extraAppConfig:
    - configMapRef: backstage-app-config-override
      filename: app-config.override.yaml
  # Extra secrets for backend auth cookie and Dex client secret
  extraEnvVarsSecrets:
    - backstage-app-secrets
  extraEnvVars:
    - name: KUBERNETES_CLUSTER_DOMAIN
      value: "cluster.local"
    - name: NODE_TLS_REJECT_UNAUTHORIZED
      value: "0"
  # Mount the catalog users ConfigMap
  extraVolumes:
    - name: catalog-users
      configMap:
        name: backstage-catalog-users
        defaultMode: 420
  extraVolumeMounts:
    - name: catalog-users
      mountPath: /app/catalog-users
      readOnly: true
  # Backstage image configuration
  image:
    registry: docker.io
    repository: roucru/idp-blueprint-dev-portal
    tag: latest
    pullPolicy: Always

# @section -- Pod settings
replicaCount: 1
priorityClassName: platform-dashboards
resources:
  requests:
    cpu: 300m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 1Gi

serviceAccount:
  create: true
  name: backstage-kubernetes

service:
  # Default chart configuration works
  type: ClusterIP

ingress:
  enabled: false

# REMOVED: Moved to backstage.extraVolumes below

appConfig:
  app:
    title: Backstage
  techdocs:
    builder: "local"
    generator:
      runIn: "docker"
    publisher:
      type: "local"
  catalog:
    rules:
      - allow: [Component, API, System, Domain, Resource, Template, Location, User, Group]
    locations:
      - type: file
        target: /app/catalog-users/admin.yaml
      - type: file
        target: /app/catalog-users/dev.yaml
  backend:
    listen:
      port: 7007
    database:
      # Use the built-in Bitnami PostgreSQL subchart
      client: pg
      connection:
        host: backstage-postgresql-hl
        port: 5432
        user: backstage
        password: ${POSTGRES_PASSWORD}
        database: backstage
        ssl:
          enabled: false
  auth:
    environment: production
    session:
      secret: ${BACKEND_SECRET}
  kubernetes:
    serviceLocatorMethod:
      type: "multiTenant"
    customResources:
      - group: "argoproj.io"
        apiVersion: "v1alpha1"
        plural: "rollouts"
      - group: "argoproj.io"
        apiVersion: "v1alpha1"
        plural: "applications"

# @section -- PostgreSQL
postgresql:
  enabled: true
  commonLabels:
    app.kubernetes.io/version: "15.4.0"
    app.kubernetes.io/part-of: idp
    owner: platform-team
    business-unit: infrastructure
    environment: demo
  auth:
    username: backstage
    database: backstage
    existingSecret: backstage-postgresql
    secretKeys:
      adminPasswordKey: postgres-password
      userPasswordKey: password
  primary:
    persistence:
      enabled: true
      size: 8Gi
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi
    podAnnotations:
      argocd.argoproj.io/sync-wave: "0"
