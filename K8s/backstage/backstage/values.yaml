# @section -- Global labels
commonLabels:
  app.kubernetes.io/version: "2.6.3"
  app.kubernetes.io/part-of: idp
  owner: platform-team
  business-unit: infrastructure
  environment: demo

# @section -- Backstage configuration
backstage:
  # Extra app-config from ConfigMap with DNS_SUFFIX-substituted values
  extraAppConfig:
    - configMapRef: backstage-app-config-override
      filename: app-config.override.yaml
  # Extra secrets for backend auth cookie and Dex client secret
  extraEnvVarsSecrets:
    - backstage-app-secrets
  extraEnvVars:
    - name: KUBERNETES_CLUSTER_DOMAIN
      value: "cluster.local"
    - name: NODE_TLS_REJECT_UNAUTHORIZED
      value: "0"
  # Backstage image configuration
  image:
    registry: docker.io
    repository: roucru/idp-blueprint-dev-portal
    tag: latest
    pullPolicy: Always

  # ArgoCD sync wave - deploy after Dex is ready
  podAnnotations:
    argocd.argoproj.io/sync-wave: "1"

  # Wait for Dex to be ready before starting Backstage
  initContainers:
    - name: wait-for-dex
      image: roucru/idp-blueprint:ops
      imagePullPolicy: IfNotPresent
      env:
        - name: HOME
          value: /tmp
        - name: XDG_CACHE_HOME
          value: /tmp/.cache
      volumeMounts:
        - name: tmp-volume
          mountPath: /tmp
      command:
        - devbox
        - run
        - --
        - sh
        - -c
        - |
          echo "Waiting for Dex service to be ready..."
          max_attempts=60
          attempt=0
          until curl -f -s http://dex.backstage.svc.cluster.local:5556/.well-known/openid-configuration > /dev/null 2>&1; do
            attempt=$((attempt + 1))
            if [ $attempt -gt $max_attempts ]; then
              echo "ERROR: Dex did not become ready after $max_attempts attempts (5 minutes)"
              exit 1
            fi
            echo "Attempt $attempt/$max_attempts: Dex not ready, waiting 5 seconds..."
            sleep 5
          done
                      echo "SUCCESS: Dex is ready!"
                    securityContext:
                      allowPrivilegeEscalation: false
                      capabilities:
                        drop: ["ALL"]
                      readOnlyRootFilesystem: true
                      runAsNonRoot: true
                      runAsUser: 1001
            extraVolumeMounts:    - name: tmp-volume
      mountPath: /tmp
  extraVolumes:
    - name: tmp-volume
      emptyDir: {}

# @section -- Pod settings
replicaCount: 1
priorityClassName: platform-dashboards
resources:
  requests:
    cpu: 300m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 1Gi

serviceAccount:
  create: true
  name: backstage-kubernetes

service:
  # Default chart configuration works
  type: ClusterIP

ingress:
  enabled: false

appConfig:
  app:
    title: Backstage
  techdocs:
    builder: "local"
    generator:
      runIn: "docker"
    publisher:
      type: "local"
  catalog:
    rules:
      - allow: [Component, API, System, Domain, Resource, Template, Location, User, Group]
  backend:
    listen:
      port: 7007
    database:
      client: pg
      connection:
        host: backstage-postgresql-hl
        port: 5432
        user: backstage
        password: ${POSTGRES_PASSWORD}
        database: backstage
        ssl:
          enabled: false
  auth:
    environment: production
    session:
      secret: ${BACKEND_SECRET}
  kubernetes:
    serviceLocatorMethod:
      type: "multiTenant"
    customResources:
      - group: "argoproj.io"
        apiVersion: "v1alpha1"
        plural: "rollouts"
      - group: "argoproj.io"
        apiVersion: "v1alpha1"
        plural: "applications"

# @section -- PostgreSQL
postgresql:
  enabled: true
  commonLabels:
    app.kubernetes.io/version: "15.4.0"
    app.kubernetes.io/part-of: idp
    owner: platform-team
    business-unit: infrastructure
    environment: demo
  auth:
    username: backstage
    database: backstage
    # checkov:skip=CKV_SECRET_6:False positive, key name not secret value
    existingSecret: backstage-postgresql
    secretKeys:
      # checkov:skip=CKV_SECRET_6:False positive, key name not secret value
      adminPasswordKey: postgres-password
      # checkov:skip=CKV_SECRET_6:False positive, key name not secret value
      userPasswordKey: password
  primary:
    persistence:
      enabled: true
      size: 8Gi
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
    podAnnotations:
      argocd.argoproj.io/sync-wave: "0"