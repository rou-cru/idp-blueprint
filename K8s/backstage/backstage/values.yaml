# @section -- Backstage image
image:
  repository: backstage/backstage
  tag: latest
  pullPolicy: IfNotPresent

# @section -- Pod settings
replicaCount: 1
priorityClassName: platform-dashboards
resources:
  requests:
    cpu: 300m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 1Gi

serviceAccount:
  create: false
  name: backstage-kubernetes

service:
  # Default chart configuration works
  type: ClusterIP

ingress:
  enabled: false

# Mount the catalog users ConfigMap
extraVolumes:
  - name: catalog-users
    configMap:
      name: backstage-demo-users

extraVolumeMounts:
  - name: catalog-users
    mountPath: /opt/app-root/src/catalog-users.yaml
    subPath: users.yaml

# Extra secrets for backend auth cookie and DB password
extraEnv:
  - name: BACKEND_SECRET
    valueFrom:
      secretKeyRef:
        name: backstage-app-secrets
        key: BACKEND_SECRET
  - name: POSTGRES_PASSWORD
    valueFrom:
      secretKeyRef:
        name: backstage-app-secrets
        key: POSTGRES_PASSWORD
  - name: DEX_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: backstage-app-secrets
        key: DEX_CLIENT_SECRET

appConfig:
  app:
    title: Backstage
    baseUrl: https://backstage.${DNS_SUFFIX}
  catalog:
    locations:
      - type: file
        target: /opt/app-root/src/catalog-users.yaml
        rules:
          - allow: [User, Group]
  backend:
    baseUrl: https://backstage.${DNS_SUFFIX}
    listen:
      port: 7007
    cors:
      origin: https://backstage.${DNS_SUFFIX}
    database:
      # Use the built-in Bitnami PostgreSQL subchart
      client: pg
      connection:
        host: backstage-postgresql-hl
        port: 5432
        user: backstage
        password: ${POSTGRES_PASSWORD}
        database: backstage
        ssl:
          enabled: false
  auth:
    environment: production
    session:
      secret: ${BACKEND_SECRET}
    providers:
      oidc:
        production:
          metadataUrl: https://dex.${DNS_SUFFIX}/.well-known/openid-configuration
          clientId: backstage
          clientSecret: ${DEX_CLIENT_SECRET}
          prompt: auto
          signIn:
            resolvers:
              - resolver: emailMatchingUserEntityProfileEmail
              - resolver: emailLocalPartMatchingUserEntityName
  kubernetes:
    serviceLocatorMethod:
      type: 'multiTenant'
    clusterLocatorMethods:
      - type: 'config'
        clusters:
          - name: local-cluster
            url: https://kubernetes.default.svc
            authProvider: 'serviceAccount'
            skipTLSVerify: false
            skipMetricsLookup: false
            dashboardUrl: https://kubernetes-dashboard.${DNS_SUFFIX}
            dashboardApp: standard
    customResources:
      - group: 'argoproj.io'
        apiVersion: 'v1alpha1'
        plural: 'rollouts'
      - group: 'argoproj.io'
        apiVersion: 'v1alpha1'
        plural: 'applications'

# @section -- PostgreSQL (Bitnami subchart)
postgresql:
  enabled: true
  auth:
    username: backstage
    database: backstage
    existingSecret: backstage-postgresql
    secretKeys:
      adminPasswordKey: postgres-password
      userPasswordKey: password
  primary:
    persistence:
      enabled: true
      size: 8Gi
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 500m
        memory: 1Gi
    podAnnotations:
      argocd.argoproj.io/sync-wave: "1"
