apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-config-tpl
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
data:
  app-config.override.yaml: |
    backend:
      baseUrl: https://backstage.${DNS_SUFFIX}
      cors:
        origin: https://backstage.${DNS_SUFFIX}
        methods: [GET, POST, PUT, DELETE]
        credentials: true
      csp:
        connect-src: ["'self'", 'https://dex.${DNS_SUFFIX}', 'https://kubernetes.default.svc']
    app:
      title: Backstage
      baseUrl: https://backstage.${DNS_SUFFIX}
    auth:
      environment: production
      session:
        secret: ${BACKEND_SECRET}
      providers:
        oidc:
          production:
            metadataUrl: https://dex.${DNS_SUFFIX}/.well-known/openid-configuration
            clientId: backstage
            clientSecret: ${DEX_CLIENT_SECRET}
            prompt: auto
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
                - resolver: emailLocalPartMatchingUserEntityName
    catalog:
      # Ensure local user catalog is always registered (prevents auth resolver failures
      # if base chart defaults change).
      locations:
        - type: file
          target: /app/catalog-users/users.yaml
      providers:
        github:
          production:
            organization: "${GITHUB_ORG}"
            catalogPath: "/catalog-info.yaml"
            filters:
              branch: "${GITHUB_BRANCH}"
              repository: "${GITHUB_REPO}"
    techdocs:
      builder: 'local'
      generator:
        runIn: 'docker'
      publisher:
        type: 'local'

    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      customResources:
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'applications'
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'rollouts'
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'workflows'
        - group: 'kyverno.io'
          apiVersion: 'v1'
          plural: 'policies'
        - group: 'kyverno.io'
          apiVersion: 'v1'
          plural: 'clusterpolicies'
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: ${CLUSTER_NAME}
              authProvider: 'serviceAccount'
              skipTLSVerify: false
              caFile: '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
              skipMetricsLookup: false
