apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-config-tpl
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
data:
  app-config.override.yaml: |
    backend:
      baseUrl: https://backstage.${DNS_SUFFIX}
      cors:
        origin: https://backstage.${DNS_SUFFIX}
        methods: [GET, POST, PUT, DELETE]
        credentials: true
      csp:
        connect-src: ["'self'", 'https://dex.${DNS_SUFFIX}', 'https://kubernetes.default.svc']
      reading:
        allow:
          - github.com
          - raw.githubusercontent.com
    app:
      title: Backstage
      baseUrl: https://backstage.${DNS_SUFFIX}
    auth:
      environment: production
      session:
        secret: ${BACKEND_SECRET}
      providers:
        oidc:
          production:
            metadataUrl: https://dex.${DNS_SUFFIX}/.well-known/openid-configuration
            clientId: backstage
            clientSecret: ${DEX_CLIENT_SECRET}
            prompt: auto
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
                - resolver: emailLocalPartMatchingUserEntityName
    integrations:
      github:
        - host: github.com
          # Optional; if empty Backstage will use unauthenticated requests (OK for public repos, may hit rate limits).
          token: ${GITHUB_TOKEN}
    catalog:
      # Allow User/Group ingestion (default rules only allow Component/API/Location) so auth
      # can resolve identities from the static catalog file.
      rules:
        - allow: [Component, API, System, Domain, Resource, Template, Location, User, Group]
      # Ensure local user catalog is always registered (prevents auth resolver failures
      # if base chart defaults change).
      locations:
        - type: file
          target: /app/catalog-users/users.yaml
        # Fallback static location so the repo is ingested even if the GitHub provider is rate-limited
        # or misconfigured. The discovery provider remains the primary mechanism.
        - type: url
          target: https://raw.githubusercontent.com/${GITHUB_ORG}/${GITHUB_REPO}/${GITHUB_BRANCH}/catalog-info.yaml
      providers:
        github:
          production:
            organization: "${GITHUB_ORG}"
            catalogPath: "/catalog-info.yaml"
            filters:
              branch: "${GITHUB_BRANCH}"
              repository: "${GITHUB_REPO}"
            schedule:
              frequency: PT5M
              timeout: PT2M
              initialDelay: PT1M
    techdocs:
      builder: 'local'
      generator:
        runIn: 'docker'
      publisher:
        type: 'local'
      # Ensure GitHub token is available for pulling mkdocs docs when needed.
      legacyUseCaseSensitiveTripletPaths: false

    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      customResources:
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'applications'
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'rollouts'
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'workflows'
        - group: 'kyverno.io'
          apiVersion: 'v1'
          plural: 'policies'
        - group: 'kyverno.io'
          apiVersion: 'v1'
          plural: 'clusterpolicies'
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: ${CLUSTER_NAME}
              authProvider: 'serviceAccount'
              skipTLSVerify: false
              caFile: '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
              skipMetricsLookup: false
