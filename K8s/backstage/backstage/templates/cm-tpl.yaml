apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-config-tpl
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
data:
  app-config.override.yaml: |
    backend:
      baseUrl: https://backstage.${DNS_SUFFIX}
      cors:
        origin: https://backstage.${DNS_SUFFIX}
        methods: [GET, POST, PUT, DELETE]
        credentials: true
      csp:
        connect-src: ["'self'", 'https://dex.${DNS_SUFFIX}', 'https://kubernetes.default.svc']
      reading:
        allow:
          - host: github.com
          - host: raw.githubusercontent.com
    app:
      title: Backstage
      baseUrl: https://backstage.${DNS_SUFFIX}
    auth:
      environment: production
      session:
        secret: ${BACKEND_SECRET}
      providers:
        oidc:
          production:
            metadataUrl: https://dex.${DNS_SUFFIX}/.well-known/openid-configuration
            clientId: backstage
            clientSecret: ${DEX_CLIENT_SECRET}
            prompt: auto
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
                - resolver: emailLocalPartMatchingUserEntityName
    integrations:
      github:
        - host: github.com
          # Optional; if empty Backstage will use unauthenticated requests (OK for public repos, may hit rate limits).
          token: ${GITHUB_TOKEN}
    catalog:
      # Allow User/Group ingestion (default rules only allow Component/API/Location) so auth
      # can resolve identities from the static catalog file.
      rules:
        - allow: [Component, API, System, Domain, Resource, Template, Location, User, Group]
      # Ensure local user catalog is always registered (prevents auth resolver failures
      # if base chart defaults change).
      locations:
        - type: file
          target: /app/catalog-users/users.yaml

      providers:
        github:
          idp-blueprint:
            organization: ${GITHUB_ORG}
            filters:
              repository: ${GITHUB_REPO}
              branch: ${GITHUB_BRANCH}
            catalogPath: '/Catalog/**/*.yaml'
    techdocs:
      builder: 'local'
      generator:
        runIn: 'docker'
      publisher:
        type: 'local'
      # Ensure GitHub token is available for pulling mkdocs docs when needed.
      legacyUseCaseSensitiveTripletPaths: false

    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      customResources:
        # Only include resources that are actually deployed and provide value
        # ArgoCD Applications - useful for showing deployment status
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'applications'
        # Note: Rollouts removed (not installed in cluster)
        # Note: Workflows removed (no instances exist, causes 404 spam)
        # Note: Kyverno policies removed (cluster-scoped, not namespace-scoped - Backstage tries to fetch per namespace causing 404s)
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: ${CLUSTER_NAME}
              authProvider: 'serviceAccount'
              skipTLSVerify: false
              caFile: '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
              skipMetricsLookup: false
