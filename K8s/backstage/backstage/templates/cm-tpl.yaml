apiVersion: v1
kind: ConfigMap
metadata:
  name: backstage-config-tpl
  namespace: backstage
  annotations:
    argocd.argoproj.io/sync-wave: "-2"
data:
  app-config.override.yaml: |
    backend:
      baseUrl: https://backstage.${DNS_SUFFIX}
      cors:
        origin: https://backstage.${DNS_SUFFIX}
        methods: [GET, POST, PUT, DELETE]
        credentials: true
      csp:
        connect-src: ["'self'", 'https://dex.${DNS_SUFFIX}', 'https://kubernetes.default.svc']
    app:
      title: Backstage
      baseUrl: https://backstage.${DNS_SUFFIX}
    auth:
      environment: production
      session:
        secret: ${BACKEND_SECRET}
      providers:
        oidc:
          production:
            metadataUrl: https://dex.${DNS_SUFFIX}/.well-known/openid-configuration
            clientId: backstage
            clientSecret: ${DEX_CLIENT_SECRET}
            prompt: auto
            signIn:
              resolvers:
                - resolver: emailMatchingUserEntityProfileEmail
                - resolver: emailLocalPartMatchingUserEntityName
    techdocs:
      builder: 'local'
      generator:
        runIn: 'docker'
      publisher:
        type: 'local'
    catalog:
      locations:
        - type: file
          target: /app/catalog-users.yaml
          rules:
            - allow: [User, Group]
        # IT Components
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/IT/argocd/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/IT/cert-manager/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/IT/cilium/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/IT/external-secrets/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/IT/gateway/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/IT/vault/catalog-info.yaml
        # K8s Components
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/K8s/argocd/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/K8s/backstage/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/K8s/cicd/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/K8s/events/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/K8s/observability/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/K8s/security/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/K8s/vault/catalog-info.yaml
        # Policies Components
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/Policies/kyverno/catalog-info.yaml
        - type: url
          target: https://github.com/rou-cru/idp-blueprint/blob/main/Policies/policy-reporter/catalog-info.yaml

    kubernetes:
      serviceLocatorMethod:
        type: 'multiTenant'
      customResources:
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'applications'
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'rollouts'
        - group: 'argoproj.io'
          apiVersion: 'v1alpha1'
          plural: 'workflows'
        - group: 'kyverno.io'
          apiVersion: 'v1'
          plural: 'policies'
        - group: 'kyverno.io'
          apiVersion: 'v1'
          plural: 'clusterpolicies'
      clusterLocatorMethods:
        - type: 'config'
          clusters:
            - url: https://kubernetes.default.svc
              name: ${CLUSTER_NAME}
              authProvider: 'serviceAccount'
              skipTLSVerify: false
              caFile: '/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
              skipMetricsLookup: false
