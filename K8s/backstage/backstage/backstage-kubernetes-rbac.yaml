apiVersion: v1
kind: ServiceAccount
metadata:
  name: backstage-kubernetes
  namespace: backstage
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: kubernetes-plugin
    app.kubernetes.io/part-of: idp
    owner: platform-team
    business-unit: infrastructure
    environment: demo
  annotations:
    argocd.argoproj.io/sync-wave: "0"
    description: 'ServiceAccount for Backstage Kubernetes plugin to access cluster resources'
    contact: platform-team
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: backstage-kubernetes-reader
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: kubernetes-plugin
    app.kubernetes.io/part-of: idp
  annotations:
    description: 'ClusterRole for Backstage to read K8s resources across namespaces'
rules:
  # Core resources
  - apiGroups:
      - ""
    resources:
      - pods
      - pods/log
      - services
      - configmaps
      - secrets
      - persistentvolumes
      - persistentvolumeclaims
      - namespaces
      - events
      - limitranges
      - resourcequotas
    verbs:
      - get
      - list
      - watch
  
  # Apps
  - apiGroups:
      - apps
    resources:
      - deployments
      - replicasets
      - statefulsets
      - daemonsets
    verbs:
      - get
      - list
      - watch
  
  # Batch
  - apiGroups:
      - batch
    resources:
      - jobs
      - cronjobs
    verbs:
      - get
      - list
      - watch
  
  # Networking
  - apiGroups:
      - networking.k8s.io
    resources:
      - ingresses
      - networkpolicies
    verbs:
      - get
      - list
      - watch
  
  # HPA
  - apiGroups:
      - autoscaling
    resources:
      - horizontalpodautoscalers
    verbs:
      - get
      - list
      - watch
  
  # Metrics
  - apiGroups:
      - metrics.k8s.io
    resources:
      - pods
      - nodes
    verbs:
      - get
      - list
  
  # ArgoCD Applications
  - apiGroups:
      - argoproj.io
    resources:
      - applications
      - rollouts
      - workflows
    verbs:
      - get
      - list
      - watch
  
  # Custom Resources
  - apiGroups:
      - external-secrets.io
    resources:
      - externalsecrets
      - secretstores
    verbs:
      - get
      - list
      - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: backstage-kubernetes-reader
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: kubernetes-plugin
    app.kubernetes.io/part-of: idp
  annotations:
    description: 'Binds backstage-kubernetes-reader role to backstage ServiceAccount'
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: backstage-kubernetes-reader
subjects:
  - kind: ServiceAccount
    name: backstage-kubernetes
    namespace: backstage
