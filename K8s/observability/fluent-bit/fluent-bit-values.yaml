# kind -- DaemonSet or Deployment

priorityClassName: platform-observability

kind: DaemonSet

# replicaCount -- Only applicable if kind=Deployment
replicaCount: 1

## @section Resource Management
## @description Defines resource requests and limits for the Fluent-bit pod.
resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 100m
    memory: 128Mi

# -- Time to wait before flushing data (in seconds)
flush: 1
metricsPort: 2020

# -- Default log level.
logLevel: info

## @section Fluent-bit Configuration
## @description Defines the core behavior, using a structured configuration.
config:
  service: |
    [SERVICE]
        Flush {{ .Values.flush }}
        Log_Level {{ .Values.logLevel }}
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port {{ .Values.metricsPort }}
        Health_Check On

  inputs: |
    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        multiline.parser cri
        Tag kube.*
        Mem_Buf_Limit 5MB
        Skip_Long_Lines On
        # Disable inotify to prevent "too many open files" errors
        # Use stat-based file watching instead
        Inotify_Watcher false
        DB /var/fluent-bit/state/flb_kube.db
        DB.Sync Normal
        Path_Key filename
        Ignore_Older 24h
        Threaded On

  filters: |
    [FILTER]
        Name kubernetes
        Match *
        # -- Enrich logs with Kubernetes metadata.
        Merge_Log On
        # -- Do not keep the original log after merging.
        Keep_Log Off
        # -- Allow pods to suggest a parser.
        K8S-Logging.Parser On
        # -- Allow pods to be excluded from logging.
        K8S-Logging.Exclude On

    # The following Lua filter removes known high-cardinality labels to protect Loki's
    # performance. A 'deny-list' approach is used because it's more performant
    # than a Lua-based 'allow-list' and the built-in Kubernetes filter does not
    # support selective inclusion.
    [FILTER]
        Name        lua
        Match       kube.*
        script      /fluent-bit/scripts/remove_labels.lua
        call        remove_labels
  outputs: |
    [OUTPUT]
        Name loki
        Match *
        Host loki.observability.svc.cluster.local
        Port 3100
        # -- Automatically add all Kubernetes labels to the log record.
        auto_kubernetes_labels true
        # -- Number of retries before dropping logs.
        Retry_Limit 5

## @section Volume Configuration
## @description Disable /etc/machine-id mount (not available in K3d containers)
daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers
  - name: fluentbitstate
    hostPath:
      path: /var/fluent-bit/state
  - name: scripts
    configMap:
      name: "{{ include \"fluent-bit.fullname\" . }}-scripts"
      defaultMode: 0755

daemonSetVolumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true
  - name: fluentbitstate
    mountPath: /var/fluent-bit/state

## @section Health Checks
## @description Tune probes to account for Loki dependency startup time
# -- Readiness probe for the Fluent-bit pod.
readinessProbe:
  httpGet:
    path: /api/v1/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

# -- Liveness probe for the Fluent-bit pod.
livenessProbe:
  httpGet:
    path: /api/v1/health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

luaScripts:
  remove_labels.lua: |
    function remove_labels(tag, timestamp, record)
      if record.kubernetes and record.kubernetes.labels then
        record.kubernetes.labels['pod-template-hash'] = nil
        record.kubernetes.labels['controller-revision-hash'] = nil
      end
      return 2, timestamp, record
    end

command:
  - /fluent-bit/bin/fluent-bit

args:
  - --workdir=/fluent-bit/etc
  - --config=/fluent-bit/etc/conf/fluent-bit.conf

## @section Hot Reload Configuration
## @description Enable automatic configuration reload when ConfigMap changes
hotReload:
  enabled: true
  image:
    repository: ghcr.io/jimmidyson/configmap-reload
    tag: v0.15.0
    digest:
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 10m
      memory: 16Mi
    limits:
      cpu: 50m
      memory: 32Mi
  extraWatchVolumes:
    - name: scripts
      mountPath: /watch/scripts
  securityContext:
    privileged: false
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65532
    runAsGroup: 65532
    capabilities:
      drop:
        - ALL

volumeMounts:
  - name: config
    mountPath: /fluent-bit/etc/conf

dashboards:
  enabled: true
  labelKey: grafana_dashboard
  labelValue: 1
  annotations: {}
  namespace: ""
  deterministicUid: false

serviceMonitor:
  enabled: false
