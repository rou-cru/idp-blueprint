## @section Resource Management
## @description Defines resource requests and limits for the Fluent-bit pod.
resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 100m
    memory: 128Mi

## @section Fluent-bit Configuration
## @description Defines the core behavior, using a structured configuration.
config:
  service: |
    [SERVICE]
        # -- Time to wait before flushing data (in seconds).
        Flush 10
        # -- Default log level.
        Log_Level info
        # -- Enable monitoring endpoint.
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port 2020
        Health_Check On

  inputs: |
    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        multiline.parser docker, cri
        Tag kube.*
        Mem_Buf_Limit 5MB
        Skip_Long_Lines On
        DB /var/fluent-bit/state/flb_kube.db
        DB.Sync Normal
        Path_Key filename
        Ignore_Older 24h

  filters: |
    [FILTER]
        Name kubernetes
        Match *
        # -- Enrich logs with Kubernetes metadata.
        Merge_Log On
        # -- Do not keep the original log after merging.
        Keep_Log Off
        # -- Allow pods to suggest a parser.
        K8S-Logging.Parser On
        # -- Allow pods to be excluded from logging.
        K8S-Logging.Exclude On

    # The following Lua filter removes known high-cardinality labels to protect Loki's
    # performance. A 'deny-list' approach is used because it's more performant
    # than a Lua-based 'allow-list' and the built-in Kubernetes filter does not
    # support selective inclusion.
    [FILTER]
        Name        lua
        Match       kube.*
        call        remove_labels
        code        function remove_labels(tag, timestamp, record)
                      if record.kubernetes and record.kubernetes.labels then
                        record.kubernetes.labels['pod-template-hash'] = nil
                        record.kubernetes.labels['controller-revision-hash'] = nil
                      end
                      return 2, timestamp, record
                    end
  outputs: |
    [OUTPUT]
        Name loki
        Match *
        Host loki.observability.svc.cluster.local
        Port 3100
        # -- Automatically add all Kubernetes labels to the log record.
        auto_kubernetes_labels true
        # -- Number of retries before dropping logs.
        Retry_Limit 5

## @section Volume Configuration
## @description Disable /etc/machine-id mount (not available in K3d containers)
daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers
  - name: fluentbitstate
    hostPath:
      path: /var/fluent-bit/state

daemonSetVolumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true
  - name: fluentbitstate
    mountPath: /var/fluent-bit/state

## @section Health Checks
## @description Tune probes to account for Loki dependency startup time
# -- Readiness probe for the Fluent-bit pod.
readinessProbe:
  httpGet:
    path: /api/v1/health
    port: http
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
# -- Liveness probe for the Fluent-bit pod.
livenessProbe:
  httpGet:
    path: /
    port: http
