# @section -- General
# -- (string) Priority class for Fluent Bit pods
priorityClassName: platform-observability

# -- (string) DaemonSet or Deployment
kind: DaemonSet

# -- (int) Only applicable if kind=Deployment
replicaCount: 1

# -- (int) Time to wait before flushing data (in seconds)
# Reduced to 2s to minimize log accumulation per batch and improve real-time visibility
flush: 2

# -- (string) Default log level
logLevel: info

# -- (int) Metrics port
metricsPort: 2020

# @section -- Resources
resources:
  requests:
    # -- (string) CPU request
    cpu: 50m
    # -- (string) Memory request
    memory: 64Mi
  limits:
    # -- (string) CPU limit
    cpu: 100m
    # -- (string) Memory limit
    memory: 128Mi

# @section -- Configuration
config:
  service: |
    [SERVICE]
        Flush {{ .Values.flush }}
        Log_Level {{ .Values.logLevel }}
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port {{ .Values.metricsPort }}
        Health_Check On

  inputs: |
    [INPUT]
        Name tail
        Path /var/log/containers/*.log
        multiline.parser cri
        Tag kube.*
        Mem_Buf_Limit 5MB
        Skip_Long_Lines On
        # Disable inotify to prevent "too many open files" errors
        # Use stat-based file watching instead
        Inotify_Watcher false
        DB /var/fluent-bit/state/flb_kube.db
        DB.Sync Normal
        Path_Key filename
        Ignore_Older 24h
        Threaded On

  filters: |
    [FILTER]
        Name kubernetes
        Match *
        # -- Enrich logs with Kubernetes metadata.
        Merge_Log On
        # -- Do not keep the original log after merging.
        Keep_Log Off
        # -- Allow pods to suggest a parser.
        K8S-Logging.Parser On
        # -- Allow pods to be excluded from logging.
        K8S-Logging.Exclude On

    # The following Lua filter removes known high-cardinality labels to protect Loki's
    # performance. A 'deny-list' approach is used because it's more performant
    # than a Lua-based 'allow-list' and the built-in Kubernetes filter does not
    # support selective inclusion.
    [FILTER]
        Name        lua
        Match       kube.*
        script      /fluent-bit/scripts/remove_labels.lua
        call        remove_labels

    [FILTER]
        Name modify
        Match *
        Condition Key_Exists kubernetes
        Rename kubernetes.namespace_name namespace
        Rename kubernetes.pod_name pod
        Rename kubernetes.container_name container

  outputs: |
    [OUTPUT]
        Name loki
        Match *
        Host loki.observability.svc.cluster.local
        Port 3100
        # -- Use JSON line format for efficient processing
        line_format json
        # -- Disable auto labels to reduce cardinality and Loki memory usage
        auto_kubernetes_labels off
        # -- Manually specify essential labels for better control
        labels job=fluentbit, namespace=$namespace, pod=$pod, container=$container
        # -- Number of retries before dropping logs
        Retry_Limit 5
        # -- Compress logs to reduce network bandwidth and memory usage
        compress gzip
        # -- Balanced buffer size (2s flush / 64k buffer = 32KB/s throughput)
        Buffer_Size 64k

# @section -- Volumes
# -- (list) DaemonSet volumes
daemonSetVolumes:
  - name: varlog
    hostPath:
      path: /var/log
  - name: varlibdockercontainers
    hostPath:
      path: /var/lib/docker/containers
  - name: fluentbitstate
    hostPath:
      path: /var/fluent-bit/state

# -- (list) DaemonSet volume mounts
daemonSetVolumeMounts:
  - name: varlog
    mountPath: /var/log
  - name: varlibdockercontainers
    mountPath: /var/lib/docker/containers
    readOnly: true
  - name: fluentbitstate
    mountPath: /var/fluent-bit/state

# -- (list) Volume mounts
volumeMounts:
  - name: config
    mountPath: /fluent-bit/etc/conf

# @section -- Health Probes
startupProbe:
  # -- (string) Probe path
  httpGet:
    # -- (string) Health check path
    path: /api/v1/health
    # -- (string) Port
    port: http
  # -- (int) Initial delay seconds
  initialDelaySeconds: 5
  # -- (int) Period seconds
  periodSeconds: 5
  # -- (int) Timeout seconds
  timeoutSeconds: 5
  # -- (int) Failure threshold
  failureThreshold: 10

readinessProbe:
  # -- (string) Probe path
  httpGet:
    # -- (string) Health check path
    path: /api/v1/health
    # -- (string) Port
    port: http
  # -- (int) Initial delay seconds
  initialDelaySeconds: 0
  # -- (int) Period seconds
  periodSeconds: 10
  # -- (int) Timeout seconds
  timeoutSeconds: 5
  # -- (int) Failure threshold
  failureThreshold: 3

livenessProbe:
  # -- (string) Probe path
  httpGet:
    # -- (string) Health check path
    path: /api/v1/health
    # -- (string) Port
    port: http
  # -- (int) Initial delay seconds
  initialDelaySeconds: 0
  # -- (int) Period seconds
  periodSeconds: 10
  # -- (int) Timeout seconds
  timeoutSeconds: 5
  # -- (int) Failure threshold
  failureThreshold: 3

# @section -- Advanced
luaScripts:
  # -- (string) Lua script to remove high-cardinality labels
  remove_labels.lua: |
    function remove_labels(tag, timestamp, record)
      if record.kubernetes and record.kubernetes.labels then
        record.kubernetes.labels['pod-template-hash'] = nil
        record.kubernetes.labels['controller-revision-hash'] = nil
      end
      return 2, timestamp, record
    end

# -- (list) Command to run
command:
  - /fluent-bit/bin/fluent-bit

# -- (list) Arguments for the command
args:
  - --workdir=/fluent-bit/etc
  - --config=/fluent-bit/etc/conf/fluent-bit.conf

# @section -- Hot Reload
hotReload:
  # -- (bool) Enable hot reload
  enabled: true

  image:
    # -- (string) Image repository
    repository: ghcr.io/jimmidyson/configmap-reload
    # -- (string) Image tag
    tag: v0.15.0
    # -- (string) Image digest
    digest:
    # -- (string) Pull policy
    pullPolicy: IfNotPresent

  resources:
    requests:
      # -- (string) CPU request
      cpu: 10m
      # -- (string) Memory request
      memory: 16Mi
    limits:
      # -- (string) CPU limit
      cpu: 50m
      # -- (string) Memory limit
      memory: 32Mi


  securityContext:
    # -- (bool) Privileged mode
    privileged: false
    # -- (bool) Allow privilege escalation
    allowPrivilegeEscalation: false
    # -- (bool) Read-only root filesystem
    readOnlyRootFilesystem: true
    # -- (bool) Run as non-root
    runAsNonRoot: true
    # -- (int) User ID
    runAsUser: 65532
    # -- (int) Group ID
    runAsGroup: 65532
    capabilities:
      # -- (list) Dropped capabilities
      drop:
        - ALL

# @section -- Dashboards
dashboards:
  # -- (bool) Enable dashboards
  enabled: true
  # -- (string) Label key for dashboards
  labelKey: grafana_dashboard
  # -- (int) Label value
  labelValue: 1
  # -- (object) Annotations
  annotations: {}
  # -- (string) Namespace
  namespace: ""
  # -- (bool) Deterministic UID
  deterministicUid: false

# @section -- Observability
serviceMonitor:
  # -- (bool) Enable ServiceMonitor
  enabled: true
