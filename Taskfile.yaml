version: '3'

vars:
  CONFIG_FILE: '{{.CONFIG_FILE | default "config.toml"}}'

  DOCKER_IMAGE_NAME:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' images.docker_image_name | tr -d '"'
  DOCKER_IMAGE_TAG:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' images.docker_image_tag | tr -d '"'
  DOCKER_IMAGE_TAG_MINIMAL:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' images.docker_image_tag_minimal | tr -d '"'

  # Network Configuration
  LAN_IP:
    sh: |
      value=$( (dasel -r toml -f '{{.CONFIG_FILE}}' network.lan_ip 2>/dev/null || true) | tr -d '"' )
      if [ -n "$value" ] && [ "$value" != '""' ]; then
        echo "$value"
      else
        ip route get 1.1.1.1 2>/dev/null | awk '{print $7; exit}' || echo "127.0.0.1"
      fi
  NODEPORT_HTTP:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' network.nodeport_http | tr -d '"'
  NODEPORT_HTTPS:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' network.nodeport_https | tr -d '"'

  REPO_URL:
    sh: |
      value=$( (dasel -r toml -f '{{.CONFIG_FILE}}' git.repo_url 2>/dev/null || true) | tr -d '"' )
      if [ -n "$value" ] && [ "$value" != '""' ] && [ "$value" != "''" ]; then
        echo "$value"
      else
        git config --get remote.origin.url 2>/dev/null || echo "https://github.com/rou-cru/idp-blueprint.git"
      fi
  TARGET_REVISION:
    sh: |
      value=$( (dasel -r toml -f '{{.CONFIG_FILE}}' git.target_revision 2>/dev/null || true) | tr -d '"' )
      if [ -n "$value" ] && [ "$value" != '""' ] && [ "$value" != "''" ]; then
        echo "$value"
      else
        git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "HEAD"
      fi

  # Helm Chart Versions
  CILIUM_VERSION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' versions.cilium | tr -d '"'
  CERT_MANAGER_VERSION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' versions.cert_manager | tr -d '"'
  PROMETHEUS_CRDS_VERSION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' versions.prometheus_operator_crds | tr -d '"'
  GATEWAY_API_VERSION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' versions.gateway_api | tr -d '"'
  EXTERNAL_SECRETS_VERSION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' versions.external_secrets | tr -d '"'
  VAULT_VERSION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' versions.vault | tr -d '"'
  ARGOCD_VERSION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' versions.argocd | tr -d '"'

  # Operational Settings
  KUBECTL_TIMEOUT:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' operational.kubectl_timeout | tr -d '"'
  K3D_CONFIG:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' operational.k3d_config | tr -d '"'
  REGISTRY_CACHE_PATH:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' operational.registry_cache_path | tr -d '"'

  # Cluster
  CLUSTER_NAME:
    sh: |
      value=$( (dasel -r toml -f '{{.CONFIG_FILE}}' cluster.name 2>/dev/null || true) | tr -d '"' )
      if [ -n "$value" ] && [ "$value" != '""' ]; then echo "$value"; else echo "idp-demo"; fi

  # ArgoCD Configuration
  ARGOCD_SYNC_TIMEOUT:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' argocd.sync_timeout | tr -d '"'
  ARGOCD_BACKOFF_DURATION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' argocd.backoff_duration | tr -d '"'
  ARGOCD_BACKOFF_FACTOR:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' argocd.backoff_factor | tr -d '"'
  ARGOCD_BACKOFF_MAX_DURATION:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' argocd.backoff_max_duration | tr -d '"'
  ARGOCD_RETRY_LIMIT:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' argocd.retry_limit | tr -d '"'

  # Gateway Timeouts
  GATEWAY_WAIT_TIMEOUT:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' gateway.wait_timeout | tr -d '"'

  # Password Configuration
  ARGOCD_ADMIN_PASSWORD:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' passwords.argocd_admin | tr -d '"'
  GRAFANA_ADMIN_PASSWORD:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' passwords.grafana_admin | tr -d '"'
  SONARQUBE_ADMIN_PASSWORD:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' passwords.sonarqube_admin | tr -d '"'
  SONARQUBE_MONITORING_PASSCODE:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' passwords.sonarqube_monitoring | tr -d '"'

  # Docker Registry Configuration
  DOCKER_REGISTRY_URL:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' registry.url | tr -d '"'
  DOCKER_REGISTRY_USERNAME:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' registry.username | tr -d '"'
  DOCKER_REGISTRY_PASSWORD:
    sh: dasel -r toml -f '{{.CONFIG_FILE}}' registry.password | tr -d '"'

  # Fuses (feature toggles)
  FUSE_POLICIES:
    sh: |
      v=$( (dasel -r toml -f '{{.CONFIG_FILE}}' fuses.policies 2>/dev/null || true) | tr -d '"' ); [ -z "$v" ] && v=true; echo "$v"
  FUSE_SECURITY:
    sh: |
      v=$( (dasel -r toml -f '{{.CONFIG_FILE}}' fuses.security 2>/dev/null || true) | tr -d '"' ); [ -z "$v" ] && v=true; echo "$v"
  FUSE_OBSERVABILITY:
    sh: |
      v=$( (dasel -r toml -f '{{.CONFIG_FILE}}' fuses.observability 2>/dev/null || true) | tr -d '"' ); [ -z "$v" ] && v=true; echo "$v"
  FUSE_CICD:
    sh: |
      v=$( (dasel -r toml -f '{{.CONFIG_FILE}}' fuses.cicd 2>/dev/null || true) | tr -d '"' ); [ -z "$v" ] && v=true; echo "$v"
  FUSE_PROD:
    sh: |
      v=$( (dasel -r toml -f '{{.CONFIG_FILE}}' fuses.prod 2>/dev/null || true) | tr -d '"' ); [ -z "$v" ] && v=false; echo "$v"

includes:
  k3d:
    taskfile: ./Task/k3d.yaml
  bootstrap:
    taskfile: ./Task/bootstrap.yaml
  stacks:
    taskfile: ./Task/stacks.yaml
  image:
    taskfile: ./Task/image.yaml
  quality:
    taskfile: ./Task/quality.yaml
  utils:
    taskfile: ./Task/utils.yaml

tasks:
  deploy:
    desc: 'Deploy the entire IDP platform'
    preconditions:
      - sh: test -f {{.CONFIG_FILE}}
        msg:
          'config.toml not found. Please keep the configuration file at the repo root.'
    cmds:
      - defer:
          echo '{{if .EXIT_CODE}}‚ö†Ô∏è  Deployment failed! Run "task destroy" to clean up
          and retry.{{else}}Success üòå{{end}}'
      # 1. Bootstrap Cluster
      - task: k3d:k3d:create
      - task: bootstrap:it:apply-namespaces
      - task: bootstrap:it:bootstrap
      - task: bootstrap:cilium:deploy
      # 2. Secrets & Certs Management
      - task: bootstrap:it:deploy-secret-and-certs
      - task: bootstrap:external-secrets:deploy
      # 3. Deploy GitOps Engine
      - task: bootstrap:argocd:deploy
      # 4. Deploy Gateway (requires cert-manager ClusterIssuer)
      - task: bootstrap:gateway:deploy
      # 5. Deploy Policy as Code Engine
      - task: stacks:policies
      # 6. Deploy Application Stacks for everything else
      - task: stacks:deploy
      - exit 0

  deploy:nocache:
    desc: 'Deploy without registry cache (test slow pulls)'
    cmds:
      - task: deploy
        vars:
          K3D_CONFIG: IT/k3d-cluster.yaml

  destroy:
    desc: 'Remove all IDP related components and cluster'
    cmds:
      - task: k3d:k3d:destroy

  redeploy:
    desc: 'Destroy the current environment and deploy from scratch'
    cmds:
      - task: destroy
      - task: deploy
