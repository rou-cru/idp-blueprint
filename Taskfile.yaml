version: "3"

# Load all variables from .env (auto-generated from config.toml)
dotenv: [".env"]

vars:
  # Default fallback values (overridden by .env if present)
  CONFIG_FILE: '{{.CONFIG_FILE | default "config.toml"}}'

includes:
  internal:
    taskfile: ./Task/_internal.yaml
  k3d:
    taskfile: ./Task/k3d.yaml
  bootstrap:
    taskfile: ./Task/bootstrap.yaml
  stacks:
    taskfile: ./Task/stacks.yaml
  image:
    taskfile: ./Task/image.yaml
  quality:
    taskfile: ./Task/quality.yaml
  utils:
    taskfile: ./Task/utils.yaml
  docs:
    taskfile: ./Task/docs.yaml

tasks:
  deploy:
    desc: "Deploy the entire IDP platform"
    interactive: true
    cmds:
      - task: internal:generate-env
      # Source .env to override inherited vars with new values, then run deploy-core
      - cmd: set -a && . ./.env && set +a && task deploy-core

  deploy-core:
    desc: "Core deployment logic (do not run directly)"
    deps:
      - internal:validate-tools
    preconditions:
      - sh: test -f {{.CONFIG_FILE}}
        msg: "config.toml not found. Please keep the configuration file at the repo root."
    cmds:
      - defer:
          echo '{{if .EXIT_CODE}}‚ö†Ô∏è  Deployment failed! Run "task destroy" to clean up
          and retry.{{else}}Success üòå{{end}}'
      # 1. Bootstrap Cluster
      - task: k3d:k3d:create
      - task: bootstrap:it:apply-namespaces
      - task: bootstrap:it:bootstrap
      - task: bootstrap:cilium:deploy
      # 2. Secrets & Certs Management
      - task: bootstrap:it:deploy-secret-and-certs
      - task: bootstrap:external-secrets:deploy
      # 3. Deploy GitOps Engine
      - task: bootstrap:argocd:deploy
      # 4. Deploy Gateway (requires cert-manager ClusterIssuer)
      - task: bootstrap:gateway:deploy
      # 5. Deploy Policy as Code Engine
      - task: stacks:policies
      # 6. Deploy Application Stacks for everything else
      - task: stacks:deploy

  destroy:
    desc: "Remove all IDP related components and cluster"
    cmds:
      - task: k3d:k3d:destroy

  redeploy:
    desc: "Destroy the current environment and deploy from scratch"
    cmds:
      - task: destroy
      - task: deploy
