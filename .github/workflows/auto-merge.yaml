name: Auto Merge with CodeRabbit

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, review_requested]
  workflow_run:
    workflows: ["CI Pipeline", "Documentation"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read
  statuses: read

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event.workflow_run.event == 'pull_request'
    steps:
      - name: Get PR context
        id: ctx
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request
              ? context.payload.pull_request
              : await (async () => {
                  // workflow_run path
                  const run = context.payload.workflow_run
                  const prData = run.pull_requests && run.pull_requests[0]
                  if (!prData) return null
                  const { data } = await github.rest.pulls.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prData.number,
                  })
                  return data
                })()

            if (!pr) {
              core.setFailed('No pull_request context available')
              return
            }

            // basic guards
            if (pr.draft) {
              core.setOutput('status', 'skip-draft')
              return
            }
            if (pr.state !== 'open') {
              core.setOutput('status', 'skip-closed')
              return
            }
            if (pr.mergeable_state === 'behind') {
              core.setOutput('status', 'skip-behind')
              return
            }
            if (!pr.mergeable_state || pr.mergeable_state === 'unknown') {
              core.setOutput('status', 'skip-unknown')
              core.info('Mergeable state is unknown, waiting for GitHub to compute it')
              return
            }
            const acceptableStates = ['clean', 'unstable', 'has_hooks']
            if (!acceptableStates.includes(pr.mergeable_state)) {
              core.setOutput('status', `skip-${pr.mergeable_state}`)
              core.info(`Mergeable state '${pr.mergeable_state}' not acceptable for auto-merge`)
              return
            }

            core.setOutput('pr-number', pr.number.toString())
            core.setOutput('mergeable_state', pr.mergeable_state || 'unknown')
            core.setOutput('status', 'ready')

      - name: Enable auto-merge
        if: steps.ctx.outputs.status == 'ready' &&
            steps.ctx.outputs.mergeable_state != 'behind' &&
            steps.ctx.outputs.mergeable_state != 'unknown'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.ctx.outputs.pr-number }}
          merge-method: squash
