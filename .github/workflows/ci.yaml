name: CI Pipeline

on:
  # Run CI as Quality Gate on PRs only (not on push to main)
  pull_request:
    branches: [main]

# Prevent concurrent runs on the same PR
concurrency:
  group: ci-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  changes:
    name: Detect changed areas
    runs-on: ubuntu-latest
    outputs:
      docs: ${{ steps.set.outputs.docs }}
      values: ${{ steps.set.outputs.values }}
      docker: ${{ steps.set.outputs.docker }}
      other: ${{ steps.set.outputs.other }}
      full: ${{ steps.set.outputs.full }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v45
        with:
          files: |
            **/*

      - name: Classify changes
        id: set
        run: |
          docs=false
          values=false
          docker=false
          other=false
          for file in ${{ steps.changed.outputs.all_changed_files }}; do
            case "$file" in
              Docs/*|*.md) docs=true ;;
              *values.yaml|*values*.yaml) values=true ;;
              Dockerfile|*/Dockerfile|docker-bake.hcl|Task/image.yaml|.devcontainer/*|devbox*.json|.devcontainer/devbox*.json|UI/*) docker=true ;;
              *) other=true ;;
            esac
          done
          if $values || $docker || $other; then
            full=true
          else
            full=false
          fi
          {
            echo "docs=$docs"
            echo "values=$values"
            echo "docker=$docker"
            echo "other=$other"
            echo "full=$full"
          } >> "$GITHUB_OUTPUT"

  docs-pr:
    name: Docs only
    needs: changes
    if: needs.changes.outputs.docs == 'true' && needs.changes.outputs.full == 'false'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: Docs/pnpm-lock.yaml
      - name: Install dependencies
        working-directory: Docs
        run: pnpm install --frozen-lockfile
      - name: Build docs
        working-directory: Docs
        run: pnpm build

  core-ci:
    name: Core CI
    needs: changes
    if: needs.changes.outputs.full == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Prepare Devbox configuration
        run: ln -sf devbox-minimal.json devbox.json
        working-directory: .devcontainer

      - name: Install Devbox
        uses: jetpack-io/devbox-install-action@v0.14.0
        with:
          project-path: .devcontainer
          enable-cache: true

      - name: Run Linting Tasks
        run: devbox run -- task quality:lint
        working-directory: .devcontainer
        timeout-minutes: 10

      - name: Run Security Scans
        run: devbox run -- task quality:security
        working-directory: .devcontainer
        timeout-minutes: 15

      - name: Run Validations
        run: devbox run -- task quality:validate
        working-directory: .devcontainer
        timeout-minutes: 12

      - name: Generate Helm docs (values.yaml changed)
        if: needs.changes.outputs.values == 'true'
        run: devbox run -- task utils:docs:helm
        working-directory: .devcontainer

  docker-build:
    name: Docker bake smoke
    needs: changes
    if: needs.changes.outputs.docker == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build images (cache-only)
        env:
          IMAGE_NAME: roucru/idp-blueprint
          IMAGE_TAG: latest
          IMAGE_TAG_MINIMAL: minimal
          IMAGE_TAG_OPS: ops
        run: |
          docker buildx bake dev minimal ops dev-portal \
            --progress=plain \
            --set *.output=type=cacheonly

  ci-green:
    name: CI green
    needs: [changes, docs-pr, core-ci, docker-build]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Evaluate job results
        env:
          CHANGES_RESULT: ${{ needs.changes.result }}
          DOCS_RESULT: ${{ needs.docs-pr.result }}
          CORE_RESULT: ${{ needs.core-ci.result }}
          DOCKER_RESULT: ${{ needs.docker-build.result }}
        run: |
          failed=false
          for item in \
            "changes=$CHANGES_RESULT" \
            "docs-pr=$DOCS_RESULT" \
            "core-ci=$CORE_RESULT" \
            "docker-build=$DOCKER_RESULT"
          do
            result="${item#*=}"
            if [ "$result" = "failure" ] || [ "$result" = "cancelled" ]; then
              echo "::error::Job ${item%=*} finished with ${result}"
              failed=true
            fi
          done
          if $failed; then
            exit 1
          fi
