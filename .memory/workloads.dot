digraph WorkloadsSubgraph {
  graph [label="Workloads View Subgraph" labelloc=top fontsize=20];
  rankdir=TB;
  node [shape=box fontsize=10];

  "Workloads View" [shape=oval style=filled fillcolor="#f3f3f3" label="Workloads View\n[View]"];

  "K3d-Cluster" [label="K3d-Cluster"];

  "CA ClusterIssuer" [label="CA ClusterIssuer"];
  "Self-Signed ClusterIssuer" [label="Self-Signed ClusterIssuer"];
  "IDP Demo CA Certificate" [label="IDP Demo CA Certificate"];
  "IDP Demo CA Secret" [label="IDP Demo CA Secret"];
  "IDP Wildcard Certificate" [label="IDP Wildcard Certificate"];
  "IDP Wildcard Certificate Secret" [label="IDP Wildcard Certificate Secret"];

  "IDP Gateway" [label="IDP Gateway"];
  "HTTPRoute:argocd" [label="argocd"];
  "HTTPRoute:sonarqube" [label="sonarqube"];
  "HTTPRoute:argo-workflows" [label="argo-workflows"];
  "HTTPRoute:grafana" [label="grafana"];
  "HTTPRoute:pyrra" [label="pyrra"];
  "HTTPRoute:vault-ui" [label="vault-ui"];
  "HTTPRoute:argo-events" [label="argo-events"];

  "Chart:cilium" [label="cilium\nv1.18.2"];
  "Chart:vault" [label="vault\nv0.31.0"];
  "Chart:cert-manager" [label="cert-manager\nv1.19.0"];
  "Chart:external-secrets" [label="external-secrets\nv0.20.2"];
  "Chart:argocd" [label="argocd\nv8.6.0"];
  "Chart:kyverno" [label="kyverno\nv3.5.2"];
  "Chart:policy-reporter" [label="policy-reporter\nv3.5.0"];
  "Chart:kube-prometheus-stack" [label="kube-prometheus-stack\nv77.14.0"];
  "Chart:loki" [label="loki\nv6.42.0"];
  "Chart:fluent-bit" [label="fluent-bit\nv0.54.0"];
  "Chart:sonarqube" [label="sonarqube\nv2025.5.0"];
  "Chart:trivy-operator" [label="trivy-operator\nv0.31.0"];
  "Chart:argo-workflows" [label="argo-workflows\nv0.45.27"];
  "Chart:pyrra" [label="pyrra\nv0.7.5"];
  "Chart:argo-events" [label="argo-events\nv1.9.2"];
  "Chart:argocd/redis" [label="redis\nv8.6.0 (subchart)"];
  "Chart:kube-prometheus-stack/prometheus" [label="prometheus\nv77.14.0 (subchart)"];
  "Chart:kube-prometheus-stack/grafana" [label="grafana\nv77.14.0 (subchart)"];
  "Chart:sonarqube/postgresql" [label="postgresql\nv2025.5.0 (subchart)"];

  "Cert-Manager" [label="Cert-Manager"];
  "ArgoCD Application Controller" [label="Application Controller"];
  "ArgoCD Repo Server" [label="Repo Server"];
  "ArgoCD Server" [label="Server"];
  "Cilium" [label="Cilium"];
  "SonarQube" [label="SonarQube"];
  "Argo Workflows" [label="Argo Workflows"];
  "Argo Events" [label="Argo Events"];
  "Backstage" [label="Backstage\n(planned)"];
  "Redis" [label="Redis"];
  "Vault" [label="Vault"];
  "External-Secrets-Operator" [label="External-Secrets-Operator"];
  "Kyverno" [label="Kyverno"];
  "Policy Reporter" [label="Policy Reporter"];
  "Prometheus" [label="Prometheus"];
  "Grafana" [label="Grafana"];
  "Loki" [label="Loki"];
  "Fluent Bit" [label="Fluent Bit"];
  "Trivy-Operator" [label="Trivy-Operator"];
  "Pyrra" [label="Pyrra"];
  "SecretStore:vault-backend" [label="vault-backend"];
  "SecretStore:observability" [label="observability"];
  "SecretStore:cicd" [label="cicd"];
  "PostgreSQL" [label="PostgreSQL"];
  "Grafana Dashboard ConfigMap" [label="Grafana Dashboard ConfigMap"];

  // Secret stores and flows (Vault -> ESO -> SecretStore -> Workload)
  "Vault" -> "External-Secrets-Operator" [label="SUPPLIES"];
  "External-Secrets-Operator" -> "SecretStore:vault-backend" [label="SYNCS_TO"];
  "External-Secrets-Operator" -> "SecretStore:observability" [label="SYNCS_TO"];
  "External-Secrets-Operator" -> "SecretStore:cicd" [label="SYNCS_TO"];
  "SecretStore:vault-backend" -> "ArgoCD Server" [label="FEEDS"];
  "SecretStore:observability" -> "Grafana" [label="FEEDS"];
  "SecretStore:cicd" -> "Argo Workflows" [label="FEEDS"];
  "SecretStore:cicd" -> "SonarQube" [label="FEEDS"];

  // Namespace entities
  "Namespace:argocd" [label="argocd\n[Namespace]"];
  "Namespace:cert-manager" [label="cert-manager\n[Namespace]"];
  "Namespace:cicd" [label="cicd\n[Namespace]"];
  "Namespace:kube-system" [label="kube-system\n[Namespace]"];
  "Namespace:observability" [label="observability\n[Namespace]"];
  "Namespace:security" [label="security\n[Namespace]"];
  "Namespace:vault-system" [label="vault-system\n[Namespace]"];
  "Namespace:external-secrets-system" [label="external-secrets-system\n[Namespace]"];
  "Namespace:kyverno-system" [label="kyverno-system\n[Namespace]"];
  "Namespace:argo-events" [label="argo-events\n[Namespace]"];

  // Cluster namespaces hosted on K3d
  "K3d-Cluster" -> "Namespace:argocd" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:cert-manager" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:cicd" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:kube-system" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:observability" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:security" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:vault-system" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:external-secrets-system" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:kyverno-system" [label="PROVIDES"];
  "K3d-Cluster" -> "Namespace:argo-events" [label="PROVIDES"];

  // Cluster-scoped resources
  "K3d-Cluster" -> "CA ClusterIssuer" [label="HOSTS"];
  "K3d-Cluster" -> "Self-Signed ClusterIssuer" [label="HOSTS"];
  "K3d-Cluster" -> "Cilium" [label="REQUIRES"];

  // Workloads View ownership (only bootstrap charts, GitOps charts are managed by ArgoCD)
  "Workloads View" -> "K3d-Cluster" [label="INCLUDES"];
  "Workloads View" -> "Chart:cilium" [label="INCLUDES"];
  "Workloads View" -> "Chart:vault" [label="INCLUDES"];
  "Workloads View" -> "Chart:cert-manager" [label="INCLUDES"];
  "Workloads View" -> "Chart:external-secrets" [label="INCLUDES"];
  "Workloads View" -> "Chart:argocd" [label="INCLUDES"];

  // Chart deployments (con subcharts explícitos para visibilidad de reestructuración)
  "Chart:vault" -> "Vault" [label="DEPLOYS"];
  "Chart:external-secrets" -> "External-Secrets-Operator" [label="DEPLOYS"];
  "Chart:kyverno" -> "Kyverno" [label="DEPLOYS"];
  "Chart:policy-reporter" -> "Policy Reporter" [label="DEPLOYS"];
  "Chart:kube-prometheus-stack" -> "Chart:kube-prometheus-stack/prometheus" [label="SUBCHART"];
  "Chart:kube-prometheus-stack/prometheus" -> "Prometheus" [label="DEPLOYS"];
  "Chart:kube-prometheus-stack" -> "Chart:kube-prometheus-stack/grafana" [label="SUBCHART"];
  "Chart:kube-prometheus-stack/grafana" -> "Grafana" [label="DEPLOYS"];
  "Chart:loki" -> "Loki" [label="DEPLOYS"];
  "Chart:fluent-bit" -> "Fluent Bit" [label="DEPLOYS"];
  "Chart:trivy-operator" -> "Trivy-Operator" [label="DEPLOYS"];
  "Chart:pyrra" -> "Pyrra" [label="DEPLOYS"];
  "Chart:argocd" -> "ArgoCD Application Controller" [label="DEPLOYS"];
  "Chart:argocd" -> "ArgoCD Repo Server" [label="DEPLOYS"];
  "Chart:argocd" -> "ArgoCD Server" [label="DEPLOYS"];
  "Chart:argocd" -> "Chart:argocd/redis" [label="SUBCHART"];
  "Chart:argocd/redis" -> "Redis" [label="DEPLOYS"];

  // ArgoCD Application Controller reconciles GitOps-managed charts
  "ArgoCD Application Controller" -> "Chart:kyverno" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:policy-reporter" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:kube-prometheus-stack" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:loki" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:fluent-bit" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:sonarqube" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:trivy-operator" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:argo-workflows" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:pyrra" [label="RECONCILES"];
  "ArgoCD Application Controller" -> "Chart:argo-events" [label="RECONCILES"];
  "Chart:cert-manager" -> "Cert-Manager" [label="DEPLOYS"];
  "Chart:cilium" -> "Cilium" [label="DEPLOYS"];
  "Chart:sonarqube" -> "SonarQube" [label="DEPLOYS"];
  "Chart:sonarqube" -> "Chart:sonarqube/postgresql" [label="SUBCHART"];
  "Chart:sonarqube/postgresql" -> "PostgreSQL" [label="DEPLOYS"];
  "Chart:argo-workflows" -> "Argo Workflows" [label="DEPLOYS"];
  "Chart:argo-events" -> "Argo Events" [label="DEPLOYS"];

  // Namespace → Helm releases
  "Namespace:argocd" -> "Chart:argocd" [label="HOSTS"];
  "Namespace:argocd" -> "SecretStore:vault-backend" [label="HOSTS"];
  "Namespace:cert-manager" -> "Chart:cert-manager" [label="HOSTS"];
  "Namespace:cicd" -> "Chart:argo-workflows" [label="HOSTS"];
  "Namespace:cicd" -> "Chart:sonarqube" [label="HOSTS"];
  "Namespace:cicd" -> "SecretStore:cicd" [label="HOSTS"];
  "Namespace:kube-system" -> "Chart:cilium" [label="HOSTS"];
  "Namespace:observability" -> "Chart:kube-prometheus-stack" [label="HOSTS"];
  "Namespace:observability" -> "Chart:loki" [label="HOSTS"];
  "Namespace:observability" -> "Chart:fluent-bit" [label="HOSTS"];
  "Namespace:observability" -> "Chart:pyrra" [label="HOSTS"];
  "Namespace:observability" -> "SecretStore:observability" [label="HOSTS"];
  "Namespace:security" -> "Chart:trivy-operator" [label="HOSTS"];
  "Namespace:vault-system" -> "Chart:vault" [label="HOSTS"];
  "Namespace:external-secrets-system" -> "Chart:external-secrets" [label="HOSTS"];
  "Namespace:kyverno-system" -> "Chart:kyverno" [label="HOSTS"];
  "Namespace:kyverno-system" -> "Chart:policy-reporter" [label="HOSTS"];
  "Namespace:argo-events" -> "Chart:argo-events" [label="HOSTS"];

  // Namespace → direct resources
  "Namespace:argocd" -> "HTTPRoute:argocd" [label="HOSTS"];
  "Namespace:cert-manager" -> "IDP Demo CA Certificate" [label="HOSTS"];
  "Namespace:cert-manager" -> "IDP Demo CA Secret" [label="HOSTS"];
  "Namespace:cicd" -> "HTTPRoute:sonarqube" [label="HOSTS"];
  "Namespace:cicd" -> "HTTPRoute:argo-workflows" [label="HOSTS"];
  "Namespace:observability" -> "HTTPRoute:grafana" [label="HOSTS"];
  "Namespace:observability" -> "HTTPRoute:pyrra" [label="HOSTS"];
  "Namespace:observability" -> "Grafana Dashboard ConfigMap" [label="HOSTS"];
  "Namespace:kube-system" -> "IDP Gateway" [label="HOSTS"];
  "Namespace:kube-system" -> "IDP Wildcard Certificate" [label="HOSTS"];
  "Namespace:kube-system" -> "IDP Wildcard Certificate Secret" [label="HOSTS"];
  "Namespace:vault-system" -> "HTTPRoute:vault-ui" [label="HOSTS"];
  "Namespace:argo-events" -> "HTTPRoute:argo-events" [label="HOSTS"];

  // Workloads expose metrics to Prometheus (data flows: Workload -> Prometheus)
  "ArgoCD Application Controller" -> "Prometheus" [label="SCRAPED_BY"];
  "ArgoCD Repo Server" -> "Prometheus" [label="SCRAPED_BY"];
  "ArgoCD Server" -> "Prometheus" [label="SCRAPED_BY"];
  "Argo Workflows" -> "Prometheus" [label="SCRAPED_BY"];
  "Trivy-Operator" -> "Prometheus" [label="SCRAPED_BY"];
  "Pyrra" -> "Prometheus" [label="SCRAPED_BY"];
  "Cilium" -> "Prometheus" [label="SCRAPED_BY"];
  "Kyverno" -> "Prometheus" [label="SCRAPED_BY"];
  "Vault" -> "Prometheus" [label="SCRAPED_BY"];
  "External-Secrets-Operator" -> "Prometheus" [label="SCRAPED_BY"];

  // PKI relationships
  "Self-Signed ClusterIssuer" -> "IDP Demo CA Certificate" [label="ISSUES"];
  "IDP Demo CA Certificate" -> "IDP Demo CA Secret" [label="STORES"];
  "CA ClusterIssuer" -> "IDP Wildcard Certificate" [label="ISSUES"];
  "IDP Wildcard Certificate" -> "IDP Wildcard Certificate Secret" [label="STORES"];
  "Cert-Manager" -> "CA ClusterIssuer" [label="MANAGES"];
  "Cert-Manager" -> "Self-Signed ClusterIssuer" [label="MANAGES"];
  "Cert-Manager" -> "IDP Demo CA Certificate" [label="MANAGES"];
  "Cert-Manager" -> "IDP Demo CA Secret" [label="MANAGES"];
  "Cert-Manager" -> "IDP Wildcard Certificate" [label="MANAGES"];
  "Cert-Manager" -> "IDP Wildcard Certificate Secret" [label="MANAGES"];
  "IDP Wildcard Certificate Secret" -> "IDP Gateway" [label="FEEDS"];
  "Cilium" -> "IDP Gateway" [label="IMPLEMENTS"];

  // Gateway relationships (exploration: Gateway → HTTPRoute → Workload)
  "IDP Gateway" -> "HTTPRoute:argocd" [label="ROUTES"];
  "HTTPRoute:argocd" -> "ArgoCD Server" [label="TARGETS"];
  "IDP Gateway" -> "HTTPRoute:sonarqube" [label="ROUTES"];
  "HTTPRoute:sonarqube" -> "SonarQube" [label="TARGETS"];
  "IDP Gateway" -> "HTTPRoute:argo-workflows" [label="ROUTES"];
  "HTTPRoute:argo-workflows" -> "Argo Workflows" [label="TARGETS"];
  "IDP Gateway" -> "HTTPRoute:grafana" [label="ROUTES"];
  "HTTPRoute:grafana" -> "Grafana" [label="TARGETS"];
  "IDP Gateway" -> "HTTPRoute:pyrra" [label="ROUTES"];
  "HTTPRoute:pyrra" -> "Pyrra" [label="TARGETS"];
  "IDP Gateway" -> "HTTPRoute:vault-ui" [label="ROUTES"];
  "HTTPRoute:vault-ui" -> "Vault" [label="TARGETS"];
  "IDP Gateway" -> "HTTPRoute:argo-events" [label="ROUTES"];
  "HTTPRoute:argo-events" -> "Argo Events" [label="TARGETS"];

  // Component dependencies
  "ArgoCD Application Controller" -> "Redis" [label="USES"];
  "ArgoCD Repo Server" -> "Redis" [label="USES"];
  "ArgoCD Server" -> "Redis" [label="USES"];
  "SonarQube" -> "PostgreSQL" [label="USES"];

  // Observability relationships (data flows toward consumers)
  "Fluent Bit" -> "Loki" [label="SENDS_TO"];
  "Prometheus" -> "Grafana" [label="FEEDS"];
  "Loki" -> "Grafana" [label="FEEDS"];
  "Prometheus" -> "Pyrra" [label="FEEDS"];
  "Kyverno" -> "Policy Reporter" [label="FEEDS"];
}
