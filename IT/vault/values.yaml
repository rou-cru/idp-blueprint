# @section -- Server
server:
  # -- (string) Priority class for Vault pods
  priorityClassName: platform-infrastructure
  # -- Update strategy for zero-downtime updates (StatefulSet)
  updateStrategyType: RollingUpdate
  affinity: |
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: vault
              app.kubernetes.io/instance: vault
              component: server
          topologyKey: kubernetes.io/hostname
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
  standalone:
    # -- (bool) Enables standalone server configuration
    enabled: true
    # -- (string) HCL configuration for the Raft storage backend
    config: |
      ui = true

      storage "raft" {
        path    = "/vault/data"
        node_id = "vault-0"
      }
      listener "tcp" {
        address         = "0.0.0.0:8200"
        tls_disable     = "true"
        telemetry {
          unauthenticated_metrics_access = true
        }
      }
      telemetry {
        prometheus_retention_time = "30s"
        disable_hostname          = true
      }
      audit "file" {
        path = "/vault/logs/audit.log"
      }
  dataStorage:
    # -- (bool) Enable persistence
    enabled: true
    # -- (string) Storage size
    size: 1Gi
  resources:
    requests:
      # -- (string) Memory request
      memory: 256Mi
      # -- (string) CPU request
      cpu: 250m
    limits:
      # -- (string) Memory limit
      memory: 512Mi
      # -- (string) CPU limit
      cpu: 500m
  livenessProbe:
    # -- (bool) Enable liveness probe
    enabled: true
    # -- (int) Failure threshold
    failureThreshold: 3
    # -- (int) Initial delay seconds
    initialDelaySeconds: 15
    # -- (int) Period seconds
    periodSeconds: 10
    # -- (int) Success threshold
    successThreshold: 1
    # -- (int) Timeout seconds
    timeoutSeconds: 3
    # -- (list) Exec command
    execCommand: []
  readinessProbe:
    # -- (bool) Enable readiness probe
    enabled: true
    # -- (int) Failure threshold
    failureThreshold: 3
    # -- (int) Initial delay seconds
    initialDelaySeconds: 5
    # -- (int) Period seconds
    periodSeconds: 5
    # -- (int) Timeout seconds
    timeoutSeconds: 3
    # -- (string) Readiness probe path
    path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"
  serviceMonitor:
    # -- (bool) Enable ServiceMonitor
    enabled: true

# @section -- UI
ui:
  # -- (bool) Enable Vault UI
  enabled: true
  service:
    # -- (string) Service type
    type: 'ClusterIP'

serverTelemetry:
  serviceMonitor:
    enabled: true

prometheusRules:
  # Deploy the PrometheusRule custom resource for AlertManager based alerts.
  # Requires that AlertManager is properly deployed.
  enabled: true
  selectors: {}
  # Some example rules.
  rules: []
    #  - alert: vault-HighResponseTime
    #    annotations:
    #      message: The response time of Vault is over 500ms on average over the last 5 minutes.
    #    expr: vault_core_handle_request{quantile="0.5", namespace="mynamespace"} > 500
    #    for: 5m
    #    labels:
    #      severity: warning
    #  - alert: vault-HighResponseTime
    #    annotations:
    #      message: The response time of Vault is over 1s on average over the last 5 minutes.
    #    expr: vault_core_handle_request{quantile="0.5", namespace="mynamespace"} > 1000
    #    for: 5m
    #    labels:
    #      severity: critical