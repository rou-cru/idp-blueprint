# @section -- Server
server:
  # -- (string) Priority class for Vault pods
  priorityClassName: platform-infrastructure
  # -- Update strategy for zero-downtime updates (StatefulSet)
  updateStrategyType: RollingUpdate
  affinity: |
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: vault
              app.kubernetes.io/instance: vault
              component: server
          topologyKey: kubernetes.io/hostname
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
  standalone:
    # -- (bool) Enables standalone server configuration
    enabled: true
    # -- (string) HCL configuration for the Raft storage backend
    config: |
      ui = true

      storage "raft" {
        path    = "/vault/data"
        node_id = "vault-0"
      }
      listener "tcp" {
        address         = "0.0.0.0:8200"
        tls_disable     = "true"
        telemetry {
          unauthenticated_metrics_access = true
        }
      }
      telemetry {
        prometheus_retention_time = "30s"
        disable_hostname          = true
      }
      audit "file" {
        path = "/vault/logs/audit.log"
      }
  dataStorage:
    # -- (bool) Enable persistence
    enabled: true
    # -- (string) Storage size
    size: 1Gi
  resources:
    requests:
      # -- (string) Memory request
      memory: 256Mi
      # -- (string) CPU request
      cpu: 250m
    limits:
      # -- (string) Memory limit
      memory: 512Mi
      # -- (string) CPU limit
      cpu: 500m
  livenessProbe:
    # -- (bool) Enable liveness probe
    enabled: true
    # -- (int) Failure threshold
    failureThreshold: 3
    # -- (int) Initial delay seconds
    initialDelaySeconds: 60
    # -- (int) Period seconds
    periodSeconds: 10
    # -- (int) Success threshold
    successThreshold: 1
    # -- (int) Timeout seconds
    timeoutSeconds: 3
    # -- (list) Exec command
    execCommand: []

  # -- (list) Extra containers to run in the same pod
  extraContainers:
    - name: vault-unsealer
      image: roucru/idp-blueprint:ops
      command: ["/bin/sh", "-c"]
      args:
        - |
          echo "Starting Vault Unsealer Sidecar..."
          # 1. Wait for Vault to be responsive
          until curl -s -o /dev/null http://127.0.0.1:8200/v1/sys/health; do
            echo "Waiting for Vault API..."
            sleep 5
          done
          
          # 2. Check for keys (Bootstrap vs Recovery)
          if [ ! -f /vault/secrets/unseal-key ]; then
            echo "No unseal key found. Assuming initial bootstrap. Sleeping..."
            sleep infinity
          fi
          
          echo "Unseal key found. Checking status..."
          STATUS=$(curl -s http://127.0.0.1:8200/v1/sys/health)
          
          if echo "$STATUS" | grep -q '"sealed":true'; then
            echo "Vault is sealed. Attempting to unseal..."
            UNSEAL_KEY=$(cat /vault/secrets/unseal-key)
            PAYLOAD="{\"key\": \"$UNSEAL_KEY\"}"
            
            RESPONSE=$(curl -s -X POST -d "$PAYLOAD" http://127.0.0.1:8200/v1/sys/unseal)
            echo "Unseal response: $RESPONSE"
          else
            echo "Vault is already unsealed."
          fi
          
          echo "Unsealer job finished. Sleeping..."
          sleep infinity
      volumeMounts:
        - name: vault-init-keys
          mountPath: /vault/secrets
          readOnly: true

  # -- (list) Extra volumes to mount to the pod
  extraVolumes:
    - name: vault-init-keys
      secret:
        secretName: vault-init-keys
        optional: true

  readinessProbe:
    # -- (bool) Enable readiness probe
    enabled: true
    # -- (int) Failure threshold
    failureThreshold: 3
    # -- (int) Initial delay seconds
    initialDelaySeconds: 5
    # -- (int) Period seconds
    periodSeconds: 5
    # -- (int) Timeout seconds
    timeoutSeconds: 3
    # -- (string) Readiness probe path
    path: "/v1/sys/health?standbyok=true&sealedcode=204&uninitcode=204"
  serviceMonitor:
    # -- (bool) Enable ServiceMonitor
    enabled: true

# @section -- UI
ui:
  # -- (bool) Enable Vault UI
  enabled: true
  service:
    # -- (string) Service type
    type: 'ClusterIP'

serverTelemetry:
  serviceMonitor:
    enabled: true

prometheusRules:
  # Deploy the PrometheusRule custom resource for AlertManager based alerts.
  # Requires that AlertManager is properly deployed.
  enabled: true
  selectors: {}
  # Some example rules.
  rules: []
    #  - alert: vault-HighResponseTime
    #    annotations:
    #      message: The response time of Vault is over 500ms on average over the last 5 minutes.
    #    expr: vault_core_handle_request{quantile="0.5", namespace="mynamespace"} > 500
    #    for: 5m
    #    labels:
    #      severity: warning
    #  - alert: vault-HighResponseTime
    #    annotations:
    #      message: The response time of Vault is over 1s on average over the last 5 minutes.
    #    expr: vault_core_handle_request{quantile="0.5", namespace="mynamespace"} > 1000
    #    for: 5m
    #    labels:
    #      severity: critical