version: '3'

tasks:
  cleanup:
    desc: 'Remove temporary chart directories'
    internal: true
    cmds:
      - find . -type d -name charts -exec rm -rf {} +

  lint:
    desc: 'Run all linters'
    cmds:
      - task: lint:yaml
      - task: lint:shell
      - task: lint:dockerfile
      - task: lint:markdown
      - task: lint:helm

  lint:yaml:
    desc: 'Lint all YAML files'
    internal: true
    cmds:
      - yamllint -c .config/lint/.yamllint .

  lint:shell:
    desc: 'Lint all shell scripts'
    internal: true
    cmds:
      - find . -name '*.sh' -type f | grep -v '/.devbox/' | xargs -r shellcheck

  lint:dockerfile:
    desc: 'Lint all Dockerfiles'
    internal: true
    cmds:
      - find . -name Dockerfile -exec hadolint {} +

  lint:markdown:
    desc: 'Lint all Markdown files'
    internal: true
    cmds:
      - markdownlint-cli2 --config .config/lint/.markdownlint-cli2.yaml --fix "Docs/**/*.md" "*.md" "Policies/tag-policy.md" "Scripts/**/*.md" "Task/**/*.md"

  lint:helm:
    desc: 'Validate Helm values documentation completeness'
    internal: true
    cmds:
      - ./Scripts/helm-docs-lint.sh

  lint:commit:
    desc: 'Lint the last commit message'
    cmds:
      - commitlint-rs from HEAD~1

  validate:
    desc: 'Run all validation tasks'
    cmds:
      - task: validate:kubeval

  validate:kustomize:
    desc: 'Validate all Kustomize overlays by building them'
    internal: true
    cmds:
      - defer: find . -type d -name charts -exec rm -rf {} +
      - for dir in $(find . -type f -name kustomization.yaml -printf '%h\n'); do
        kustomize build $dir --enable-helm > /dev/null; done

  validate:kubeval:
    desc: 'Validate Kubernetes manifests - build Kustomize overlays and check schemas'
    internal: true
    cmds:
      - defer: find . -type d -name charts -exec rm -rf {} +
      - |
        for dir in $(find . -type f -name kustomization.yaml -printf '%h\n'); do
          kustomize build $dir --enable-helm | kubeval --ignore-missing-schemas --quiet -
        done

  security:
    desc: 'Run all security scanners'
    cmds:
      - task: security:iac
      - task: security:secrets

  security:iac:
    desc: 'Scan Infrastructure as Code for misconfigurations'
    internal: true
    cmds:
      - checkov --directory . --quiet

  security:secrets:
    desc: 'Scan for hardcoded secrets'
    internal: true
    cmds:
      - trufflehog filesystem . --exclude-paths .config/lint/.trufflehog-ignore --log-level=-1

  check:
    desc: 'Run all checks (lint, validation, security)'
    cmds:
      - task: cleanup
      - task: lint
      - task: validate
      - task: security
