version: '3'

tasks:
  cleanup:
    desc: 'Remove temporary chart directories'
    internal: true
    cmds:
      - find . -type d -name charts -exec rm -rf {} +

  lint:
    desc: 'Run all linters'
    cmds:
      - task: lint:yaml
      - task: lint:shell
      - task: lint:dockerfile
      - task: lint:markdown
      - task: lint:helm

  lint:yaml:
    desc: 'Lint all YAML files'
    internal: true
    preconditions:
      - sh: command -v yamllint
        msg: 'yamllint is required but not installed. Run: brew install yamllint'
    cmds:
      - yamllint -c .config/lint/.yamllint .

  lint:shell:
    desc: 'Lint all shell scripts'
    internal: true
    preconditions:
      - sh: command -v shellcheck
        msg: 'shellcheck is required but not installed. Run: brew install shellcheck'
    cmds:
      - find . -name '*.sh' -type f | grep -vE '/(\.devbox|node_modules|dist|\.venv|site|Docs/src/partials)/' | xargs -r shellcheck

  lint:dockerfile:
    desc: 'Lint all Dockerfiles'
    internal: true
    preconditions:
      - sh: command -v hadolint
        msg: 'hadolint is required but not installed. Run: brew install hadolint'
    cmds:
      - find . -name Dockerfile | grep -vE '/(node_modules|dist|\.venv|site|Docs/src/partials)/' | xargs -r hadolint

  lint:markdown:
    desc: 'Lint all Markdown files'
    internal: true
    preconditions:
      - sh: command -v markdownlint-cli2
        msg: 'markdownlint-cli2 is required but not installed. Run: npm install -g markdownlint-cli2'
    cmds:
      - markdownlint-cli2 --config .config/lint/.markdownlint-cli2.yaml --fix "Docs/**/*.md" "Docs/**/*.mdx" "*.md" "Policies/tag-policy.md" "Scripts/**/*.md" "Task/**/*.md"

  lint:helm:
    desc: 'Validate Helm values documentation completeness'
    internal: true
    cmds:
      - ./Scripts/helm-docs-lint.sh

  lint:commit:
    desc: 'Lint the last commit message'
    cmds:
      - commitlint-rs from HEAD~1

  validate:
    desc: 'Run all validation tasks'
    cmds:
      - task: validate:kubeval

  validate:kustomize:
    desc: 'Validate all Kustomize overlays by building them'
    internal: true
    cmds:
      - defer: find . -type d -name charts -exec rm -rf {} +
      - for dir in $(find . -type f -name kustomization.yaml -printf '%h\n'); do
        kustomize build $dir --enable-helm > /dev/null; done

  validate:kubeval:
    desc: 'Validate Kubernetes manifests - build Kustomize overlays and check schemas'
    internal: true
    cmds:
      - defer: find . -type d -name charts -exec rm -rf {} +
      - |
        for dir in $(find . -type f -name kustomization.yaml -printf '%h\n'); do
          kustomize build $dir --enable-helm | kubeval --ignore-missing-schemas --quiet -
        done

  security:
    desc: 'Run all security scanners'
    cmds:
      - task: security:iac
      - task: security:secrets

  security:iac:
    desc: 'Scan Infrastructure as Code for misconfigurations'
    internal: true
    preconditions:
      - sh: command -v checkov
        msg: 'checkov is required but not installed. Run: pip install checkov'
    cmds:
      - checkov --directory . --skip-path node_modules --skip-path dist --skip-path .venv --skip-path site --skip-path .cache --quiet

  security:secrets:
    desc: 'Scan for hardcoded secrets'
    internal: true
    preconditions:
      - sh: command -v trufflehog
        msg: 'trufflehog is required but not installed. Run: brew install trufflehog'
    cmds:
      - trufflehog filesystem . --exclude-paths .config/lint/.trufflehog-ignore --log-level=-1

  check:
    desc: 'Run all checks (lint, validation, security)'
    cmds:
      - task: cleanup
      - task: lint
      - task: validate
      - task: security
