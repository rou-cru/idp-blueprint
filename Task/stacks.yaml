version: "3"

tasks:
  policies:
    desc: "Deploy the Kyverno Policy Engine and policies via ArgoCD"
    dir: Policies
    silent: true
    env:
      REPO_URL: "{{.REPO_URL}}"
      TARGET_REVISION: "{{.TARGET_REVISION}}"
    status:
      - test "{{.FUSE_POLICIES}}" = "false"
    cmds:
      - envsubst < app-kyverno.yaml | kubectl apply -f - --server-side

  observability:
    desc: "Deploy the Observability Stack via ArgoCD"
    dir: K8s/observability
    silent: true
    env:
      REPO_URL: "{{.REPO_URL}}"
      TARGET_REVISION: "{{.TARGET_REVISION}}"
    status:
      - test "{{.FUSE_OBSERVABILITY}}" = "false"
    cmds:
      - envsubst < applicationset-observability.yaml | kubectl apply -f - --server-side

  cicd:
    desc: "Deploy the CICD Stack via ArgoCD"
    dir: K8s/cicd
    silent: true
    env:
      REPO_URL: "{{.REPO_URL}}"
      TARGET_REVISION: "{{.TARGET_REVISION}}"
    status:
      - test "{{.FUSE_CICD}}" = "false"
    cmds:
      - envsubst < applicationset-cicd.yaml | kubectl apply -f - --server-side

  security:
    desc: "Deploy the Security Stack via ArgoCD (Trivy Operator)"
    dir: K8s/security
    silent: true
    env:
      REPO_URL: "{{.REPO_URL}}"
      TARGET_REVISION: "{{.TARGET_REVISION}}"
    status:
      - test "{{.FUSE_SECURITY}}" = "false"
    cmds:
      - envsubst < applicationset-security.yaml | kubectl apply -f - --server-side

  events:
    desc: "Deploy the Events Stack via ArgoCD (Argo Events)"
    dir: K8s/events
    silent: true
    env:
      REPO_URL: "{{.REPO_URL}}"
      TARGET_REVISION: "{{.TARGET_REVISION}}"
    cmds:
      - envsubst < applicationset-events.yaml | kubectl apply -f - --server-side

  backstage:
    desc: "Deploy the Backstage developer portal via ArgoCD"
    dir: K8s/backstage
    silent: true
    env:
      REPO_URL: "{{.REPO_URL}}"
      TARGET_REVISION: "{{.TARGET_REVISION}}"
      BACKSTAGE_VERSION: "{{.BACKSTAGE_VERSION}}"
      DNS_SUFFIX: "{{.DNS_SUFFIX}}"
    status:
      - test "{{.FUSE_BACKSTAGE}}" = "false"
    cmds:
      - envsubst < applicationset-backstage.yaml | kubectl apply -f - --server-side

  deploy:
    desc: "Deploy all application stacks via ArgoCD ApplicationSets (feature-gated)"
    cmds:
      - task: policies
      - task: observability
      - task: cicd
      - task: security
      - task: backstage
      - task: events
