version: '3'

tasks:
  policies:
    desc: 'Deploy the Kyverno Policy Engine and policies via ArgoCD'
    dir: Policies
    preconditions:
      - sh: command -v envsubst
        msg: 'envsubst is required but not installed. Run: brew install gettext'
      - sh: command -v kubectl
        msg: 'kubectl is required but not installed. Run: brew install kubectl'
    env:
      REPO_URL: '{{.REPO_URL}}'
      TARGET_REVISION: '{{.TARGET_REVISION}}'
    cmds:
      - envsubst < app-kyverno.yaml | kubectl apply -f -

  observability:
    desc: 'Deploy the Observability Stack via ArgoCD'
    dir: K8s/observability
    preconditions:
      - sh: command -v envsubst
        msg: 'envsubst is required but not installed. Run: brew install gettext'
      - sh: command -v kubectl
        msg: 'kubectl is required but not installed. Run: brew install kubectl'
    env:
      REPO_URL: '{{.REPO_URL}}'
      TARGET_REVISION: '{{.TARGET_REVISION}}'
    cmds:
      - envsubst < applicationset-observability.yaml | kubectl apply -f -

  cicd:
    desc: 'Deploy the CICD Stack via ArgoCD'
    dir: K8s/cicd
    preconditions:
      - sh: command -v envsubst
        msg: 'envsubst is required but not installed. Run: brew install gettext'
      - sh: command -v kubectl
        msg: 'kubectl is required but not installed. Run: brew install kubectl'
    env:
      REPO_URL: '{{.REPO_URL}}'
      TARGET_REVISION: '{{.TARGET_REVISION}}'
    cmds:
      - envsubst < applicationset-cicd.yaml | kubectl apply -f -

  security:
    desc: 'Deploy the Security Stack via ArgoCD (Trivy Operator)'
    dir: K8s/security
    preconditions:
      - sh: command -v envsubst
        msg: 'envsubst is required but not installed. Run: brew install gettext'
      - sh: command -v kubectl
        msg: 'kubectl is required but not installed. Run: brew install kubectl'
    env:
      REPO_URL: '{{.REPO_URL}}'
      TARGET_REVISION: '{{.TARGET_REVISION}}'
    cmds:
      - envsubst < applicationset-security.yaml | kubectl apply -f -

  events:
    desc: 'Deploy the Events Stack via ArgoCD (Argo Events)'
    dir: K8s/events
    preconditions:
      - sh: command -v envsubst
        msg: 'envsubst is required but not installed. Run: brew install gettext'
      - sh: command -v kubectl
        msg: 'kubectl is required but not installed. Run: brew install kubectl'
    env:
      REPO_URL: '{{.REPO_URL}}'
      TARGET_REVISION: '{{.TARGET_REVISION}}'
    cmds:
      - envsubst < applicationset-events.yaml | kubectl apply -f -

  backstage:
    desc: 'Deploy the Backstage developer portal via ArgoCD'
    dir: K8s/backstage
    preconditions:
      - sh: command -v envsubst
        msg: 'envsubst is required but not installed. Run: brew install get text'
      - sh: command -v kubectl
        msg: 'kubectl is required but not installed. Run: brew install kubectl'
    env:
      REPO_URL: '{{.REPO_URL}}'
      TARGET_REVISION: '{{.TARGET_REVISION}}'
      DNS_SUFFIX:
        sh: |
          value=$(./Scripts/config-get.sh network.lan_ip '{{.CONFIG_FILE}}' 2>/dev/null || true)
          if [ -z "$value" ] || [ "$value" = "''" ]; then
            value=$(ip route get 1.1.1.1 2>/dev/null | awk '{print $7; exit}' || echo "127.0.0.1")
          fi
          echo "$(echo "$value" | tr '.' '-').nip.io"
    cmds:
      - envsubst < applicationset-backstage.yaml | kubectl apply -f -

  deploy:
    desc: 'Deploy all application stacks via ArgoCD ApplicationSets (feature-gated)'
    cmds:
      - |
        if [ "{{.FUSE_POLICIES}}" != "false" ]; then
          task stacks:policies || exit 1
        else
          echo "Skipping policies"
        fi
      - |
        if [ "{{.FUSE_OBSERVABILITY}}" != "false" ]; then
          task stacks:observability || exit 1
        else
          echo "Skipping observability"
        fi
      - |
        if [ "{{.FUSE_CICD}}" != "false" ]; then
          task stacks:cicd || exit 1
        else
          echo "Skipping cicd"
        fi
      - |
        if [ "{{.FUSE_SECURITY}}" != "false" ]; then
          task stacks:security || exit 1
        else
          echo "Skipping security"
        fi
      - |
        if [ "{{.FUSE_BACKSTAGE}}" != "false" ]; then
          task stacks:backstage || exit 1
        else
          echo "Skipping backstage"
        fi
      - task stacks:events
