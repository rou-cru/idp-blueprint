version: '3'

tasks:
  image:build:
    desc: 'Build the Dev Container image (full variant)'
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG: '{{.DOCKER_IMAGE_TAG}}'
    cmds:
      - docker bake dev --progress=tty

  image:build:minimal:
    desc: 'Build minimal image for CI/Jobs'
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG_MINIMAL: '{{.DOCKER_IMAGE_TAG_MINIMAL}}'
    cmds:
      - docker bake minimal --progress=tty

  image:build:ops:
    desc: 'Build ops image for cluster utility jobs'
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG_OPS: '{{.DOCKER_IMAGE_TAG_OPS}}'
    cmds:
      - docker bake ops --progress=tty

  image:release:
    desc: 'Build and push full image to Registry'
    requires:
      vars:
        - DOCKER_REGISTRY_URL
        - DOCKER_REGISTRY_USERNAME
        - DOCKER_REGISTRY_PASSWORD
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG: '{{.DOCKER_IMAGE_TAG}}'
    cmds:
      - docker bake release --progress=tty

  image:release:minimal:
    desc: 'Build and push minimal image to Registry'
    requires:
      vars:
        - DOCKER_REGISTRY_URL
        - DOCKER_REGISTRY_USERNAME
        - DOCKER_REGISTRY_PASSWORD
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG_MINIMAL: '{{.DOCKER_IMAGE_TAG_MINIMAL}}'
    cmds:
      - docker bake release-minimal --progress=tty

  image:release:ops:
    desc: 'Build and push ops image to Registry'
    requires:
      vars:
        - DOCKER_REGISTRY_URL
        - DOCKER_REGISTRY_USERNAME
        - DOCKER_REGISTRY_PASSWORD
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG_OPS: '{{.DOCKER_IMAGE_TAG_OPS}}'
    cmds:
      - docker bake release-ops --progress=tty

  image:release:all:
    desc: 'Build and push all bake targets (full, minimal, ops, dev-portal)'
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG: '{{.DOCKER_IMAGE_TAG}}'
      IMAGE_TAG_MINIMAL: '{{.DOCKER_IMAGE_TAG_MINIMAL}}'
      IMAGE_TAG_OPS: '{{.DOCKER_IMAGE_TAG_OPS}}'
    cmds:
      - docker bake release release-minimal release-ops dev-portal-release --progress=tty

  registry:clean:
    desc: 'Remove registry cache data'
    silent: true
    internal: true
    requires:
      vars:
        - REGISTRY_CACHE_PATH
    cmds:
      - rm -rf {{.REGISTRY_CACHE_PATH}}
      - echo "‚úÖ Registry cache cleaned"

  registry:info:
    desc: 'Show registry status and cache size'
    cmds:
      - |
        if docker ps --filter "name=k3d-registry.localhost" --format "{{'{{'}}.Names{{'}}'}}" | grep -q registry;
        then
          echo "‚úÖ Registry container running"
          if [ -d "{{.REGISTRY_CACHE_PATH}}" ]; then
            echo "üì¶ Cache size: $(du -sh {{.REGISTRY_CACHE_PATH}} 2>/dev/null | cut -f1)"
          else
            echo "üì¶ Cache size: empty"
          fi
          echo "üìÇ Location: {{.REGISTRY_CACHE_PATH}}"
          echo "üîó Endpoint: localhost:5000"
        else
          echo "‚ö†Ô∏è  Registry not running (using config: {{.K3D_CONFIG}})"
        fi

  # Dev Portal (Backstage) tasks
  dev-portal:build:
    desc: 'Build Backstage dev-portal Docker image (host build approach)'
    dir: UI
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG: 'latest'
    cmds:
      - echo "Installing dependencies..."
      - yarn install --immutable
      - echo "Auto-fixing code style..."
      - yarn fix
      - echo "Verifying code quality..."
      - yarn lint:all
      - echo "Generating type definitions..."
      - yarn tsc
      - echo "Building backend bundle..."
      - yarn build:backend
      - echo "Building Docker image..."
      - cd .. && docker bake dev-portal --progress=tty

  dev-portal:release:
    desc: 'Build and push dev-portal image to registry'
    dir: UI
    requires:
      vars:
        - DOCKER_REGISTRY_URL
        - DOCKER_REGISTRY_USERNAME
        - DOCKER_REGISTRY_PASSWORD
    env:
      IMAGE_NAME: '{{.DOCKER_IMAGE_NAME}}'
      IMAGE_TAG: 'latest'
    cmds:
      - echo "Installing dependencies..."
      - yarn install --immutable
      - echo "Generating type definitions..."
      - yarn tsc
      - echo "Building backend bundle..."
      - yarn build:backend
      - echo "Building and pushing Docker Image..."
      - cd .. && docker bake dev-portal-release --progress=tty

  dev-portal:clean:
    desc: 'Clean dev-portal build artifacts'
    dir: UI
    cmds:
      - echo "Cleaning build artifacts..."
      - rm -rf dist-types
      - rm -rf packages/*/dist
      - rm -rf packages/backend/dist/skeleton.tar.gz
      - rm -rf packages/backend/dist/bundle.tar.gz
      - echo "‚úÖ Build artifacts cleaned"
