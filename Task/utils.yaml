version: '3'

tasks:
  docs:deps:
    desc: 'Install MkDocs tooling via uv'
    cmds:
      - uv sync --locked

  docs:
    desc: 'Generate all automatic documentation'
    cmds:
      - task: docs:metadata
      - task: docs:helm

  docs:metadata:
    desc: 'Generate Chart.yaml metadata for all components'
    cmds:
      - ./Scripts/generate-chart-metadata.sh

  docs:helm:
    desc: 'Generate documentation for Helm charts'
    cmds:
      - ./Scripts/helm-docs-generate.sh

  docs:build:
    desc: 'Build MkDocs documentation site'
    cmds:
      - task: docs:deps
      - uv run mkdocs build --strict
    sources:
      - mkdocs.yml
      - Docs/**/*.md
      - Docs/**/*.css
    generates:
      - site/index.html
      - site/sitemap.xml

  docs:serve:
    desc: 'Serve documentation locally for development'
    cmds:
      - task: docs:deps
      - uv run mkdocs serve

  docs:linkcheck:
    desc: 'Check for broken links in documentation'
    cmds:
      - ./Scripts/docs-linkcheck.sh

  docs:lint:
    desc: 'Lint documentation markdown files'
    cmds:
      - markdownlint-cli2 "Docs/**/*.md"

  docs:clean:
    desc: 'Clean built documentation'
    cmds:
      - rm -rf site/
      - rm -rf .cache/

  docs:all:
    desc: 'Full documentation pipeline: generate, build, and validate'
    cmds:
      - task: docs
      - task: docs:build
      - task: docs:linkcheck

  ca:export:
    desc: 'Export CA certificate for browser import (optional)'
    cmds:
      - |
        kubectl get secret idp-demo-ca-secret -n cert-manager \
          -o jsonpath='{.data.tls\.crt}' | base64 -d > $HOME/idp-demo-ca.crt
        echo "âœ… CA exported to: $HOME/idp-demo-ca.crt"
        echo "   Import in browser to remove security warnings"
