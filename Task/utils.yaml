version: '3'

dotenv: [".env"]

vars:
  CONFIG_FILE: '{{.CONFIG_FILE | default "config.toml"}}'
  CLUSTER_NAME:
    sh: |
      value=$(./Scripts/config-get.sh cluster.name '{{.CONFIG_FILE}}' 2>/dev/null || true)
      if [ -n "$value" ] && [ "$value" != '""' ]; then echo "$value"; else echo "idp-demo"; fi

tasks:
  docs:
    desc: 'Generate all automatic documentation (Helm values metadata)'
    cmds:
      - task: docs:metadata
      - task: docs:helm

  docs:astro:build:
    desc: 'Build Astro/Starlight docs site'
    cmds:
      - |
        cd Docs
        pnpm install --frozen-lockfile
        pnpm build

  docs:astro:dev:
    desc: 'Run Astro/Starlight docs in dev mode'
    cmds:
      - |
        cd Docs
        pnpm install --frozen-lockfile
        pnpm dev

  docs:metadata:
    desc: 'Generate Chart.yaml metadata for all components'
    internal: true
    cmds:
      - ./Scripts/generate-chart-metadata.sh

  docs:helm:
    desc: 'Generate documentation for Helm charts'
    cmds:
      - ./Scripts/helm-docs-generate.sh

  docs:linkcheck:
    desc: 'Check for broken links in documentation'
    cmds:
      - ./Scripts/docs-linkcheck.sh

  config:print:
    desc: 'Print effective configuration (fork-friendly)'
    cmds:
      - |
        echo "Configuration (from {{.CONFIG_FILE}}):"
        echo "  Repo URL:        {{.REPO_URL}}"
        echo "  Target Revision: {{.TARGET_REVISION}}"
        echo "  Cluster Name:    {{.CLUSTER_NAME}}"
        echo "  LAN IP:          {{.LAN_IP}}"
        echo "  NodePort HTTP:   {{.NODEPORT_HTTP}}"
        echo "  NodePort HTTPS:  {{.NODEPORT_HTTPS}}"
        echo "  Prom CRDs Chart: {{.PROMETHEUS_CRDS_VERSION}}"
        echo "  Fuses: policies={{.FUSE_POLICIES}} observability={{.FUSE_OBSERVABILITY}} cicd={{.FUSE_CICD}} security={{.FUSE_SECURITY}} prod={{.FUSE_PROD}}"

  ca:export:
    desc: 'Export CA certificate for browser import (optional)'
    cmds:
      - |
        kubectl get secret {{.CLUSTER_NAME}}-ca-secret -n cert-manager \
          -o jsonpath='{.data.tls\.crt}' | base64 -d > $HOME/{{.CLUSTER_NAME}}-ca.crt
        echo "âœ… CA exported to: $HOME/{{.CLUSTER_NAME}}-ca.crt"
        echo "   Import in browser to remove security warnings"
