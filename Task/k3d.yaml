version: '3'

vars:
  CONFIG_FILE: '{{.CONFIG_FILE | default "config.toml"}}'
  CLUSTER_NAME:
    sh: |
      value=$(./Scripts/config-get.sh cluster.name '{{.CONFIG_FILE}}' 2>/dev/null || true)
      if [ -n "$value" ] && [ "$value" != '""' ]; then echo "$value"; else echo "idp-demo"; fi

tasks:
  k3d:check-inotify:
    desc: 'Check and fix inotify limits for Kubernetes controllers'
    platforms: [linux]
    internal: true
    cmds:
      - ./Scripts/check-inotify.sh

  k3d:create:
    desc: 'Create a k3d cluster with 3 nodes if it does not exist'
    deps:
      - task: k3d:check-inotify
        platforms: [linux]
    cmds:
      - |
        if k3d cluster list -o json | jq -e '.[] | select(.name == "{{.CLUSTER_NAME}}")' >/dev/null 2>&1; then
          echo "Skipping k3d cluster creation (already exists)"
        else
          TMP_CFG=$(mktemp)
          # Render k3d config with NodePort values from config.toml (envsubst is no-op if placeholders absent)
          NODEPORT_HTTP={{.NODEPORT_HTTP}} NODEPORT_HTTPS={{.NODEPORT_HTTPS}} \
            envsubst < {{.K3D_CONFIG}} > "$TMP_CFG"
          k3d cluster create {{.CLUSTER_NAME}} -c "$TMP_CFG"
          rm -f "$TMP_CFG"
        fi

  k3d:destroy:
    desc: 'Remove the k3d cluster'
    cmds:
      - k3d cluster delete {{.CLUSTER_NAME}}
