# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  k3d:check-inotify:
    desc: "Check that inotify settings are suitable for k3d"
    silent: true
    platforms: [linux]
    internal: true
    cmds:
      - ./Scripts/check-inotify.sh

  k3d:create:
    desc: "Create a k3d cluster with 3 nodes if it does not exist"
    deps:
      - task: k3d:check-inotify
    env:
      # Ensure mount propagation for Cilium eBPF maps survives host reboots.
      K3D_FIX_MOUNTS: '{{.K3D_FIX_MOUNTS | default "1"}}'
      # Avoid k3d DNS rewrite (interferes with CoreDNS/external resolution).
      K3D_FIX_DNS: '{{.K3D_FIX_DNS | default "0"}}'
      NODEPORT_HTTP: "{{.NODEPORT_HTTP}}"
      NODEPORT_HTTPS: "{{.NODEPORT_HTTPS}}"
      DOCKER_REGISTRY_URL: "{{.DOCKER_REGISTRY_URL}}"
      DOCKER_REGISTRY_USERNAME: "{{.DOCKER_REGISTRY_USERNAME}}"
      DOCKER_REGISTRY_PASSWORD: "{{.DOCKER_REGISTRY_PASSWORD}}"
    cmds:
      - |
        # Ensure dedicated Docker network exists for stability
        docker network inspect idp-network >/dev/null 2>&1 || \
        docker network create --driver bridge --subnet 172.25.0.0/16 idp-network >/dev/null

        if k3d cluster list -o json | jq -e '.[] | select(.name == "{{.CLUSTER_NAME}}")' >/dev/null 2>&1; then
          echo "Skipping k3d cluster creation (already exists)"
        else
          # Delegate to dedicated script for cleaner implementation
          ./Scripts/k3d-create-cluster.sh \
            "{{.CLUSTER_NAME}}" \
            "{{.K3D_CONFIG}}" \
            "IT/k3d-registries.yaml"
        fi

  k3d:destroy:
    desc: "Remove the k3d cluster"
    cmds:
      - k3d cluster delete {{.CLUSTER_NAME}}
      - docker network rm idp-network || true
