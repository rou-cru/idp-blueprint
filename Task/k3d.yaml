# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  k3d:check-inotify:
    desc: "Check that inotify settings are suitable for k3d"
    silent: true
    platforms: [linux]
    internal: true
    cmds:
      - ./Scripts/check-inotify.sh

  k3d:create:
    desc: "Create a k3d cluster with 3 nodes if it does not exist"
    deps:
      - task: k3d:check-inotify
    env:
      # Ensure mount propagation for Cilium eBPF maps survives host reboots.
      K3D_FIX_MOUNTS: '{{.K3D_FIX_MOUNTS | default "1"}}'
      # Avoid k3d DNS rewrite (interferes with CoreDNS/external resolution).
      K3D_FIX_DNS: '{{.K3D_FIX_DNS | default "0"}}'
    cmds:
      - |
        # Ensure dedicated Docker network exists for stability
        docker network inspect idp-network >/dev/null 2>&1 || \
        docker network create --driver bridge --subnet 172.25.0.0/16 idp-network
        
        if k3d cluster list -o json | jq -e '.[] | select(.name == "{{.CLUSTER_NAME}}")' >/dev/null 2>&1; then
          echo "Skipping k3d cluster creation (already exists)"
        else
          TMP_CFG=$(mktemp)
          # Render k3d config with NodePort values from config.toml (envsubst is no-op if placeholders absent)
          NODEPORT_HTTP={{.NODEPORT_HTTP}} NODEPORT_HTTPS={{.NODEPORT_HTTPS}} \
            envsubst < {{.K3D_CONFIG}} > "$TMP_CFG"
          k3d cluster create {{.CLUSTER_NAME}} -c "$TMP_CFG"
          rm -f "$TMP_CFG"
        fi

  k3d:destroy:
    desc: "Remove the k3d cluster"
    cmds:
      - k3d cluster delete {{.CLUSTER_NAME}}
      - docker network rm idp-network || true
