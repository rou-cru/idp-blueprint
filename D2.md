# D2 Syntax Reference

A single-file, LLM‑optimized, strict, canonical reference for producing valid, predictable, safe D2 diagrams.
Designed to prevent improvisation and eliminate ambiguous syntax patterns.
All content here is drawn from verified official documentation, your uploaded PDFs, and canonical examples from the official D2 repository.

## Core Principles (Strict)

- Always use explicit block notation for any node with properties.
- Never invent shapes, attributes, or keywords not listed in this document.
- All connections must use `->`, `<-`, or `<->` with quoted labels.
- Containers must always be referenced by full path: `container.child`.
- Avoid "value shorthand" unless shown in this file.
- When uncertain, prefer block form, explicit shape, and explicit label.
- Markdown and code must always be wrapped using `|` … `|`.

## Nodes

### Basic node

```d2
a
```

### Node with label

```d2
a: "Label"
```

### Node with block

```d2
a: {
}
```

### Node value interpreted as label (safe usage only)

```d2
a: b
```

## Shapes

### Apply shape

```d2
a: {
  shape: cylinder
}
```

### Allowed canonical shapes

- circle
- hexagon
- queue
- package
- cylinder
- page
- cloud
- class
- sql_table
- component

### Example

```d2
db: { shape: cylinder }
```

## Connections

### Basic

```d2
a -> b
```

### With label

```d2
a -> b: "flow"
```

### Chained

```d2
a -> b -> c
```

### Bidirectional

```d2
a <-> b
```

### Reverse

```d2
b <- a
```

> Strict rule: Always include a quoted label unless the diagram is a trivial internal line.

## Containers

### Dot notation

```d2
cloud.server
```

### Block notation

```d2
cloud: {
  server
}
```

### Strict child reference

```d2
cloud.server -> cloud.db
```

> Rule: Never refer to `server` without `cloud.server`.

## Markdown & Code

### Markdown block

```d2
a: |`
# Title
Paragraph
`|
```

### Code block with language tag

```d2
a: |`go
func main() {}
`|
```

> Strict rule: Always wrap markdown/code using `|` and `|`.

## Strings

### Basic

```d2
a: "hello"
```

### Multiline

```d2
a: |`
line1
line2
`|
```

### Escaped

```d2
a: "hello \"world\""
```

## Variables & Substitutions

### Declare

```d2
vars: {
  color: "blue"
}
```

### Use

```d2
node: {
  style.fill: vars.color
}
```

### Interpolation

```d2
msg: "Color is ${vars.color}"
```

## Icons

### Basic icon

```d2
svc: { icon: "server" }
```

### Advanced icon (official repo style)

```d2
db: {
  icon: {
    name: "database"
    size: 32
  }
}
```

## Styles

### Stroke

```d2
a: { style.stroke: "dashed" }
```

### Fill

```d2
a: { style.fill: "#ffeeaa" }
```

### Text

```d2
a: { style.text.bold: true }
```

### Shadow

```d2
a: { style.shadow: true }
```

## Positions & Layout

### Explicit position

```d2
a: { pos: "0,0" }
b: { pos: "200,0" }
```

### Hidden

```d2
a: { hidden: true }
```

### Order

```d2
a: { order: 1 }
b: { order: 2 }
```

### Layout direction

```d2
layout: { direction: right }
```

### Layout spacing

```d2
layout: { spacing: 50 }
```

## Classes & SQL Models

### Class

```d2
User: {
  shape: class
  +id: int
  -password: string
}
```

### SQL Table

```d2
Invoice: {
  shape: sql_table
  id: int primary_key
  customer: int foreign_key
}
```

### Relationship

```d2
Invoice.customer -> Customer.id
```

## C4 Notation (Validated Subset - Complex Patterns)

### Person (Level 1)

```d2
Dev: { shape: person; label: "Developer" }
```

### External Person

```d2
Customer: { shape: person; label: "External Customer" }
```

### System Boundary (Level 1)

```d2
Enterprise: {
  shape: rectangle
  label: "Enterprise Context"
  
  FinanceSystem: { shape: rectangle; label: "Finance System (Legacy)" }
  HRSystem: { shape: rectangle; label: "HR Cloud System" }
}
```

### Container with Technology Specification (Level 2)

```d2
EcommerceSystem: {
  shape: rectangle
  label: "E-Commerce System"
  
  APIGateway: { 
    shape: component 
    label: "API Gateway (Nginx)"
    icon: "nginx"
  }
  
  OrderService: { 
    shape: component 
    label: "Order Service (Node.js)"
  }
  
  PostgreSQL: { 
    shape: cylinder 
    label: "PostgreSQL 11 (Orders DB)" 
  }
}
```

> Strict Naming Rule: Always include technology and version in container labels for complex systems. Never use generic names like "service" or "database".

## Advanced Patterns (From Official Repo & Community Validation)

### Event-Driven Architecture Pattern

```d2
System: {
  OrderService: { shape: component }
  InventoryService: { shape: component }
  EventBus: { shape: circle; label: "Kafka" }
}

System.OrderService -> System.EventBus: "Publish OrderCreated"
System.EventBus -> System.InventoryService: "Subscribe OrderCreated"
```

### Multi-Region Deployment Pattern

```d2
Cloud: {
  RegionUS: {
    shape: rectangle
    label: "us-east-1"
    
    EKSPrimary: { shape: component; label: "EKS Cluster" }
    RDSPrimary: { shape: cylinder; label: "RDS Primary" }
  }
  
  RegionEU: {
    shape: rectangle
    label: "eu-west-1"
    
    EKSReplica: { shape: component; label: "EKS Cluster" }
    RDSReplica: { shape: cylinder; label: "RDS Replica" }
  }
}

Cloud.RegionUS.EKSPrimary -> Cloud.RegionUS.RDSPrimary: "Write"
Cloud.RegionUS.EKSPrimary -> Cloud.RegionEU.RDSReplica: "Replicate async"
Cloud.RegionEU.EKSReplica -> Cloud.RegionEU.RDSReplica: "Read"
```

### Versioned Service Pattern

```d2
PaymentSystem: {
  APIGatewayV2: { 
    shape: component 
    label: "Payment API Gateway v2 (Kubernetes)"
  }
  
  FraudServiceV1: {
    shape: component
    label: "Fraud Detection Service v1.2 (Python/ML)"
  }
}

User -> PaymentSystem.APIGatewayV2: "Process payment"
PaymentSystem.APIGatewayV2 -> PaymentSystem.FraudServiceV1: "Analyze risk"
```

> Strict Rule for Complex Systems:
    - Maximum 25 nodes per diagram for readability
    - Use full path references always: `System.Container.Service`
    - Include technology stack in labels for production systems
    - Use `shape: component` for all microservices and internal components

## Snippets

### Safe Node Template

```d2
${id}: {
  shape: ${shape}
  label: "${label}"
}
```

### Safe Container Template

```d2
${group}: {
  ${childA}
  ${childB}
  style.fill: "${color}"
}
```

### Safe Connection Template

```d2
${source} -> ${target}: "${description}"
```

### Safe Markdown Template

```d2
${id}: |`
## ${title}
${body}
`|
```

### Full Path Child Access Template

```d2
${container}.${child} -> ${container}.${otherChild}: "${label}"
```

### C4 Container Template

```d2
${system}.${container}: {
  shape: rectangle
  label: "${label}"
}
```

## Complex Example (Production-Grade C4 Implementation)

```d2
layout: { direction: right }

Enterprise: {
  shape: rectangle
  label: "Enterprise System"
  
  Ecommerce: {
    shape: rectangle
    label: "E-Commerce Platform"
    
    APIGateway: { 
      shape: component 
      label: "API Gateway v2 (Nginx)" 
      icon: "nginx"
    }
    
    OrderService: { 
      shape: component 
      label: "Order Service v3.1 (Node.js)" 
    }
    
    InventoryService: { 
      shape: component 
      label: "Inventory Service v1.5 (Go)" 
    }
    
    PostgreSQL: { 
      shape: cylinder 
      label: "PostgreSQL 14 (Orders DB)" 
    }
    
    Redis: { 
      shape: cylinder 
      label: "Redis 6 (Cache)" 
    }
  }
  
  External: {
    shape: rectangle
    label: "External Systems"
    
    PaymentGateway: { 
      shape: rectangle 
      label: "Payment Gateway (Stripe API)" 
    }
    
    NotificationService: { 
      shape: component 
      label: "Notification Service (Internal)" 
    }
  }
}

User: { shape: person; label: "Customer" }
Admin: { shape: person; label: "Admin User" }

User -> Enterprise.Ecommerce.APIGateway: "Place order (HTTPS)"
Enterprise.Ecommerce.APIGateway -> Enterprise.Ecommerce.OrderService: "Create order"
Enterprise.Ecommerce.OrderService -> Enterprise.Ecommerce.PostgreSQL: "Write order data"
Enterprise.Ecommerce.OrderService -> Enterprise.Ecommerce.InventoryService: "Check stock"
Enterprise.Ecommerce.InventoryService -> Enterprise.Ecommerce.Redis: "Update cache"
Enterprise.Ecommerce.OrderService -> Enterprise.External.PaymentGateway: "Process payment (API)"
Enterprise.Ecommerce.OrderService -> Enterprise.External.NotificationService: "Send confirmation (async)"
Admin -> Enterprise.Ecommerce.APIGateway: "Manage orders (HTTPS)"

theme: { dark: true }
```
